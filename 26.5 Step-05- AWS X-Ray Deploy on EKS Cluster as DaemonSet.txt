# 26.5 Step-05- AWS X-Ray Deploy on EKS Cluster as DaemonSet

-: Welcome back.In this step we are going to create IAMpermissions required for our AWS X-ray daemon,to run on EKS clusterand then send the x-ray tracesfrom AWS EKS cluster X-ray daemon to theAWS X-ray surveys.So for that purpose you need to create a service accountin Kubernetes.In addition to that, IAM role and then IAM policywhich will have the AWS X-ray daemon right access.So all these things,Kubernetes service account and then AWS IAM role.And then, IAM policy already therewhich we are going to leverage it.So rolland service account we are going to create witha single command using EKS CTL create IAM service account.So let's go ahead and then create that now.So the name of the service account in Kubernetes,it is going to be X-ray daemonand it is going to get created in the default name space andinside the cluster EKS demo oneand the IAM AWS IAM policyit is going to attach for the role it is going tocreate is AWS X-ray Daemon right access.Okay, so let's go ahead and then create the same thing now.So as soon as we create thisit is also going to create a cloud formation templatefor us with the IAM role associated with it.So let's go ahead and then see that once it createsit should be creating the cloud formation account.So we'll also verify the same thing now.So it's deploying disrespect you, stack, which is nothingbut deploying stackman, deploying cloud formation stack.So let me go back toAWS management console and go to cloud formation.And if you see here we already have a EKS clusterrelated cloud formation template and ALB ingress controllerrelated IAM role and then external DNS related IAM role.And also now this is related to this cluster is relatedto our node group with two nodes, whatever we are runningin private subnets.And now this is the one default X-ray daemon which iscreating now.So like this it creates and then once it creates we can goand then verify our stuff.So it got created and if you go to resources section youcan find the IAM account it has created meanslike IAM role it has created.So I can click on this role and then it should havethe AWS X-ray daemon and right access policy.Okay, AWS X-ray daemon and right access policy.So this is therole it has created as part of this section.So in our next stepwe are going to verify what all it created.Okay, so let's go back to our terminal and I'll say clearand kubectl get SCA will give the service accountsin my Kubernetes cluster.Okay, so I should have x-ray daemon now.So it create, it created exactly 70 seconds before.And then if you want you can even review rightthe X-ray daemon kubectl describeservice account X-ray daemonand it should have the role annotated herewhatever is the role AR and present here.So this role, this role, whatever is there, right?We are two and ends with MMDV.So the same thing MMDV'sthe same thing should be annotated on our service account.So this is gluing or connecting between our service accountin EKS cluster and then IAM role insides, IAM AWS, right?So now the next thing isverify the service accounts presentin our EKS daemon cluster.So using EKS CTL get IAM service accountsin EKS daemon one cluster.So this command will give all these service accountswhich were created using EKS CTL inside this cluster.So we have external DNS X-ray daemonand then ALB ingress controller.So three service accounts and then it's equivalentIAM roles we have created using EKS CTL, right?So now we are going to deploy the X-ray EKS daemon .AML.So before deploying it we'll go aheadand then verify what is that AML file.Okay, so if you go inside13 distributed tracing using AWS X-rayand then in cube manifests you'll have two folders.Okay? So one is 01 X-ray daemons setand another one is 02 applications.Okay? So in 01 X-ray daemon set you will have theX-ray daemon set .AML.So inside that one will bewith the service account information.So inside that service account information, rightwhich is X-ray daemon service account.So let's update the role, whatever we have created just now.Okay, so this is the role ARN, you can copy it from hereor for this command outputalso it provides the same X-ray daemon AR and only.Okay, so I can take this one, right?Even this one I can copyand then paste it for my service account information.Okay, so I'll make it like this.So I have copied MMD with the entire updatethe IAM role created for x-ray access.So this IAM roll layer and I have updated herein my file and the next thing is daemon set.So for daemon set also it will be similar likewhatever we have seen related to deployment only.So only thing is kind is deployment and update strategy.It is going to use me to select to update the notes.It is going to do in a rolling update fashionand it also has the standard selector templatewhich is nothing but match labels with app X-ray daemon.So CMS deployment template only you can see onlythe kind is daemon set. Okay?And it also has the port template with metadata labels.App X-ray daemon CM is presenting, selector labels.Okay? So that's about it.And in pod spec the service account it is goingto use is X-ray daemonand it has some volume information, x-ray configand then container information it is going to useand it's resources and then it supports X-rayin just ports both UDP and TCP with 2000and it is going to do a volume mount slash AWS slash X-ray.Okay? So that's about it.And another important thing here is conflict map.Whatever it is going to do is nothingbut TCP and UDP addresses listening on0 0 0 0 off 2000 with all ips on 2000 on those notes.And in addition to thatthe service means like we already discussedabout the whatever the part it is going tocreate it need to be exposed X-ray portit need to be exposed using a cluster IP service.So X-ray related cluster IP service with portsboth X-ray ingest and then X-ray TCPwith 2000 port PCP and UDP getting exposed here.So this is the X-ray daemon.So now let's go back hereand then we updated the information.Whatever is required here.The role ARN with the MMDV is the last thing, right?So it should be MMDV.So let's cross verify MMDV.That's good.So now we'll go back here and then so update also completed.Next is deploy this demonstrate.So we are going to say kubectl apply-F cube manifestand then inside 01 X-ray daemon set, this file is there.So we are going to use the complete path todo the deployment.Okay, so I'll say clear and I will paste it, right?So once it is deployedso we need to go inside our 13th sectionwhich is microservices distributed tracing, right?And inside that we are going to deploy it.So I am inside the folder 13 microservicesdistributed tracing using AWS X-ray on EKSthere I'm doing the X-ray daemon set deployment.So it should create the service account and thendaemon set config map and then it's equivalent service.So now we are going to verify everything.Okay? So kubectl, get deploy, deployment, SVC serviceand then for all the three things.Okay, so now deployment got createdand one of one deployment is ready.And then service got created which is X-ray servicewith both ports, which is a cluster IP serviceand it also created X-ray daemon in two nodes.Okay? So we can even say kubectlget ports-wide,okay, so it should be creating two, two ports in two nodes.Okay? So if you see 120 is one nodeand then 86 is one node.So per node it has created one X-ray daemon related podusing daemon set concept in Kubernetes.So that's good.So now the next thing is, soif you want we can get the daemon set information here.Kubectl get daemon set and kubectldescribe daemon set and the name isX-ray-daemon.So to view what is present in this daemon setit has the image is X-ray daemonand then image is Amazon AWS X-ray daemonexports and then host ports.Everything information related to that is present here.Okay? So it has created two partsand then those information also available here.So now the next thing is review the deployment manifestsand then application related stuff.So in our next lecture we are going to focuson application stuff.So in this lecture we have successfullycompleted creating that daemon set and then it's equaland IAM roles and then service roles.And in next lecture we'll focuson application related stuff.So I'll see you in the next lecture.Until then, bye bye.Thank you.
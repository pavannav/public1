# 11.5 Step-03- Create IAM Policy, IAM Role, k8s service account and annotate it with I

-: Welcome back.As part of step two and then step three,we are going to create the IAM policy,IAM role, and also,create a load balancer controller service accountin Kubernetes,and annotate that respective service accountwith this respective IAM role.So let's go back to our GithHub repository,and as part of step two,we are going to create a IAM policy.So here, whatever we are going to create,we are going to take the latest version.So we'll go to ourdirectory 08 New ELB application load balancers.So let's go to the terminal here, and clear this.And we are in AWS EKS Kubernetes Masterclass Internal,in my case.In your case it is going to beAWS EKS Kubernetes Masterclass.And we'll go inside 08 New ELB application load balancers.And inside that, we are going inside 0 8 0 1load balancer controller install.And inside this, if you see here, I already have the files,"IAM policy latest" and "IAM policy V231.json."So what I'm going to do is, whatever I have existing one,I'm going to remove this "IAM policy latest" one.And using this ctl-0 and IAM policy latest.json,and I'm going to download this policy from this location.So let me go here and copy this entire line. Copy.And if you see here, already, my IAM policy latest filewas already removed as part of RN command.So I'll run this command ctl-0 IAM policy latest json.So it has downloaded the latest file here.So if I say, LS LRTA,so you can find the IAM policy latest file.So you can review that directlyin our visual studio code here,and go to that 08 new ELB application load balancers,and inside 0 8 0 1 load balancer controller install.So you, if you open this IAM latest policy.json,so you can find here, in detail,the policy related permissions, right?So all these are the things it is required for us.So there are lot of permissions required for us,and all these are outlined here,out of the box from AWS perspective.So now if we come back here,if you want to use any specific version,so the file name you need to create it, with,is with that specific version,and you need to find this file with that specific version.So if you in Kubernetes 6,the repository name is AWS load balancer controller.So I'll go to github.com/,and I'll go to that load balancer controller.And if you come back here, and in main docs install, right,so if you go to, inside this folder,you will have something called docs folder.And inside docs folder, in install folder, right?So in install folder,you can find the IAM policy .json,which is the latest one, right?And you can use that one,or, you can go for a specific version,which is related to V2.3.1 or V2.3.2, et cetera,directly by specifying that version number here.And accordingly, you can download that version.So we are going to use, always, latest.So that's the reason I have provided the latest,means like, the root repository related,main repository, main branch related information here.So you can see here,so main docs install IAM policy.json,which is referring to the latest file here, right?So now let's come back here.And we have successfully downloaded that respective filein this folder, AWS 80801 load balancer controller install.And now, we are going to do is,we are going to create a IAM policy.And policy name, we are going to provide is,AWS load balancer controller IAM policy,and the policy document we are going to referencefrom file colon slash slash and our file name,which is in that respective current working directory.So we are going to create a policy using theAWS CLI command, AWS IAM create policy.So let me copy this and paste it here.And this should create the IAM policy for us.So it has created the IAM policy.And this is the ARN it has created for us.So we need to make a note of this ARN becausewe are going to reference that in upcoming sections.So for me, this is my AWS account ID,and remaining things are going to be same for you also,your account ID usually will differ,but rest all is going to be same.So anyway, I'm going to copy this and come back here,and I'll say, file new file,and just save this ARN here for a while.Now let's come back,and we have successfully created the IAM policy.So let's, in AWS services, go to IAM service,and search for this policy.So this is policy we have created.So let me copy this policy name,and in go to policies and search for that policy.And you'll find this policy,which is a customer manager policy,and inside that, all these are the information,whatever it is going to provide.Means like, the access we are going to getas part of this policy, right?So now, let's come back here.And if there are any errors also,we really don't need to worry.But just make a note of the policy ARN. That's good.So now, in the next step, we are going to create aIAM role for the AWS load balancer controller,and add as the role to the Kubernetes service account.So for this, we are going to use the eksctl, right?So using eksctl, we can do that.eksctl directly have a command called,create IAM service account.So which means,it will create a service account in Kubernetes,and also create a IAM role in AWS IAM service,and associate the policy,whatever we have created to that IAM role,and take that IAM roles ARN,and then annotate it in the Kubernetes service account.So all this with the single eksctl command,we are going to do that.And we really don't need to worry aboutmanually implementing all these things.So applicable only with eksctl manager clusters.And our cluster we have created with eksctl.And we are going to do,successfully, how we are going to do it?We are going to see now.So this command line will create a AWS IAM role.Yes, and associate the IAM policy,whatever we have created.And also will create a Kubernetes service accountin K8s cluster,and also annotate this Kubernetes service accountwith the IAM role ARN.So now let's come back here,and understand about that command.So before understanding about that command,so first verify in kube system namespace any service accountwith name AWS load balancer controller is present or not.So you can say here, come back here,and say, clear and kubectl get SCA.SCA is the earliest name first service account,and say hyphen N and kube system.In namespace kube system we are verifying,we are listing all the service accounts,And on the top, we'll verify in the,it will come in the alphabetical order.And on the top, we'll verify if there is anything withAWS load balancer controller.So with AWS, you can see AWS Cloud Provider and AWS node,but nothing else is provided here.So anyway, if you want you can provide the exact name,and then also, search.So we'll search with this name,and AWS load balancer controller,and it is saying that no service accountswith that name are found currently.Now let's come back here and understand this command,which is eksctl create IAM service account.So for this command, we need to provide the cluster name,our EKS cluster name, which is EKS demo one,and this service account,in which namespace we need to provide,our Kubernetes service account, right?So in the namespace kube system we need to create,and name of my service account is going to beAWS load balancer controller.And the policy we are going to attach. Why?Because this create IAM service account is nothing,but with IAM, it is going to create a IAM role,and service account, it is going to create aKubernetes service account.So, which means,for this IAM role you are going to attach your policy ARN.So whatever the policy you have createdin the previous step.So its ARN, we need to provide here, right?And override existing service accounts is an additional tag,and if you want you can say approve, right?So this is the command we need to provideso that it will get created.So in my case, the cluster name is EKS demo oneand namespace it need to create for everyone,it is going to be kube system,and for you, only if your cluster name is different,put it here.And name is AWS load balancer controller,which is my service account name.And attach policy ARN.So ARN, whatever we have made a nodeas part of previous step, this is the one, right?So the same thing you need to provide here.For me it is not going to change,because it's the same account ID, AWS account ID.In your case, this account ID changes, right?Or whatever the node you have made for your IAM policy.So the same thing you can replace here.And finally, you can take this command and run it.So let's come back here,and run the command eksctl create IAM service account.So let's wait for this command to executeand it need to create.So it is going to create a cloud formation stack for this.So we are going to see that. See.So creating IAM role for service account,and in kube system namespace it has created theAWS load balancer controller service account, right?So it has created the service account,and it is also deploying the stack, eksctl EKS demo oneaddon IAM service accountkube system load balancer controller.So this is the cloud formation stack name.So it is deploying the cloud formation stack,and inside that we'll have all the automationto create all these things,and then associate it with the Kubernetes service account.So let's wait for this thing to get created.So we can see here, created service accountkube system slash AWS load balancer controller.So let's come back here and verify using eksctl CLI.So let's start with, we'll do multiple verifications.So let's do one after the other.So we'll say, eksctl get IAM service account,and provide your cluster name, right?So hyphen hyphen cluster equal to EKS demo one.And if you remember earlier, when we have run this command,we have got no IAM service accounts,but after running the previous command,it should have created one service account for us, right?So in the kube system namespace,the service name is AWS load balancer controller,and it is associated with the role ARN,whatever is created in AWS IAM service.So the role name is going to beeksctl EKS demo one addon IAM service account kube role oneand then some dynamic name generated here, right?And now, so let's come back here,and verify the cloud formation templateeksctl created and IAM role.So let's go hereand go to cloud formation service.Or, you can go to servicesand search, right?So I'll open a new window here,I'll say, I don't know.So for some, yeah I got it.So let's go to the cloud formation service here,and let's verify the same thing.So we have theeksctl EKS demo one addon IAM service account.So this is the stack name for us.So let's open it.And once we open it, right?Go inside the resources taband click on the link physical ID to open the IAM role.So inside this, if you go to the resources tab,so you can find only one resource is present here.This is the resource which is nothing but a IAM role.The type is a AWS IAM role.So if you click on this,and if you want, you can open in the new tab,it will open the IAM role created for us, right?So this is the IAM role created,and it is associated with the policy,whatever we have createdAWS load balancer controller IAM policy,it is associated with that.And you'll have that trust relationsrelated to SDS assume role with,whereby identity and all these things.And now, let's come back here,and this is the ARN of this role,ARN and then so and so, so and so, right?So now let's come back here,and verify K8s service account using kubectl.Mainly, you need to verify the annotation, right?So first, we will get the service account, right?Whether it is created or not.So we list all the thingsand verify whether it is present there or not.So you can see here AWS load balancer controlleris present there.So clear, and we'll run the command,get that respective service account, right?And we should see that that service account is present,and which is created three minutes before, right?And now describe that service account,kubectl describe service accountAWS load balancer controller and hyphen N kube system.So when we describe that service account,so we should see the annotations tab mainly.So let's see here.Name of the service account is AWS load balancer controllerand namespace is kube system,and labels, you can see, App Kubernetes,(indistinct) manager by eksctl.And in the annotations you can see eks.amazonaws.com/rolearnand this is the role ARN it has been annotated with.So now let's come back here,and search for that role ARN here.And you can see this is the same thing here.So that's the important thing.So now the, you can see that newly created role ARNis added in the annotations confirming thatAWS IAM role bound to Kubernetes service account, right?So this completes the creation of service account.IAM policy, IAM role, and annotating that IAM role ARNinside this Kubernetes service account.So in our next lecture, we are going to go aheadand then install the load balancer controller using Helm.So I'll see you in the next lecture.Until then, bye bye.Thank you.
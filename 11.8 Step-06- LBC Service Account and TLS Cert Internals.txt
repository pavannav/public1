# 11.8 Step-06- LBC Service Account and TLS Cert Internals

-: Welcome back.In this step let's verify the load balancer controller logs.So we've listed the parts from the kube system name spaceand we will verify the pods.So let's come back here and clear thisand say kubectl and hyphen in(typing)kubesystem namespace and get pods.And we should get, we have two pods running here relatedto load balancer controller and those will be listed here.AWS load balancer controller, two podsand we can copy this pod name and say(typing) kubectl-n kubesystemand logs-f and provide the pod name here.And we can see the logsof that respective pod and all seems to be shown as info.So which very clearly says that we don't have any issuesbut if we have any issues or any errors it has been showingso we can see in detail, right?So but currently it is onlyat info things which we really don't need to worry.And if we want to see for other pod alsoso the same command applies for us, which isprovide the kubectl-n kubesystem logs-fand the pod name, the second pod name.And now till here everything is completed relatedto load balancer controller, right?But for additional verificationand then for additional understanding,step 0-4-0-5 and 0-4-0-6 are defined.And these are completely optionaland those who are highlighted with internalsto understand more about it.So if you want to move on, skip this and then move onto next step, our next video you can move onor if you want to see about what is present internally,we can also see these things.So this is about AWS load balancer controllerKubernetes service account internals.So this is the service account.So we will list that out in a YAML format.(typing) So let me clear this and let's waitfor the service account to be displayed in YAML format.So APA version is v-1,kind is service account,and annotation we know that our role here is outlined here.And this is managed by "eksctl"because we created this using "eksctl",IAM service account command,create IAM service account command.And now if you see here name isAWS load balancer controller,the service account name, and namespace.Additionally, it has something called "secret".So APA version, kind, metadata, and secrets, right?So inside the secrets you have something calledAWS load balancer controller token.So this is the important thingwhich we need to be worried about.So get secret and get the value from there.And then -O YAML.(typing) So I'll say kubectl-n kubesystem, right?And I'll say, (typing) get secret.And this is the secret name.So we need to take it from here. Copy.And we will provide -O YAML.So that will get the secret name YAML format, right?(typing) So let's run that and you can see you havelot of information inside this secret.So secret and you have the CA cert, and also the token.So the token, what is this token?So that's the important thing here.So if you want,so you can use SSL checker cert decoder to decode the cert.First thing is we'll go to base64 decode, right?So we'll faster deal with ca.certwhatever is present inside this secret.So this is ca.cert and this is the value.So let me copy it and paste it here and then decode.So you got the certificate information here.And this certification informationSo we'll decode one more time usingSSL checker cert decoder.So we'll go to that browserand take the base64 decoded value from hereand go to this certificate decoder and decode it, right?And you'll find here, so this is issued on so and so dateand expires on so and so date,and common name is Kubernetes,and common name is Kubernetes.So this is a standard CA cert present inside this.So this is CN is a called Kubernetes,so you can see the entire information here.So that is fine. So that is not the big thing here.So inside the secret you have something called "token".That is the important thing which we need to see.So first things first is we'll close these thingsand one more time we'll open the base64 decoderand also we'll open the jwt.ioand put them aside and go back to our secret here, right?And inside secret in the token,whatever is there in the token field,you are going to copy that value.So whenever you have output at your secret in a YAML formatyou got all this information, right?So you're taking this copy of this tokenand you are going to do a base64 decodeand take that information, right?And go here, and put it in that JWT encoded fieldand then you'll get that decoded and got that respect toJWT token.So you can see here Kubernetes service account,namespace and kubesystem, and secret name is so and soand all the information metadata about it,it is used by AWS load balancer controller.So why I am showing this JWT, right?So this load balancer controller, right?Is creating this AWS application load balancerwhenever the Ingress manifest right here is deployedand when the k8s API server gets that information,this load balancer controller watches for Ingress events,takes that and then creates thisAWS load balancer controller.So, but what is the authentication mechanismbetween this EKS cluster and AWS services?So if you want to call any AWS APA, right?Any AWS APA here, this load balancer controller isgoing to call the application load balancer APA'sand then create that, respect to load balancer controller.To call that APA it needs to havethe authentication mechanism, right?So that authentication mechanism, how it is definedin between these things is this respect to JWT token.So on a very high level, if you want to understand the APAs,the AWS service related APAsare like service APAs you can call,and the identity provider hereis going to be your EKS clusterwhich is added as identity providers in your IAM, right?So as part of 0-1-0-2 section itself. So we have added that.So if you go here and let me go here, right?And go to the AWS EKS Kubernetes masterclass,and go to the section 01 and go to 01-02 here.And if you see the step here, create an associate IAMor IDC provider for our EKS cluster, right?So let's understand that in a high level.We are not going super deep herebut let's try to understand in a high level thatthis respect to EKS cluster is addedas a identity provider for the IAM service here.See? So whatever we have done,whatever we have run this command, right?EKS details associate, IAM OIDC provider.So at that point of time our EKS cluster isadded here as a identity provider.So which means the identities present inside our EKS clusterwill be able to access the AWS servicesbased on the role assigned to the identityinside Kubernetes cluster.And inside Kubernetes clusterthe identity is nothing but the AWS load balancercontroller service account.So if you come back here, so the identity insidethe EKS cluster isAWS load balancer controller service account,and this is annotated with the IAM role herewhich has the permissions defined in this IAM policy.Based on those IAM policies,this service whatever is created,this load balancer controller will useand whatever the token generated, right?Using the token it can authenticate against theservices whatever is allowed as part of this IAM policy.And then create, update, and delete thoseapplication load balancers.So this much linking is present inside this internally.So we can go still deep and then see how thisIAM OIDC provider related pictures and all those things.But for now it becomes super advancedand then we get confused withwhat we are going to learn about the Ingress.But I just want to ensure that in the internalsof these things, so how this AWS load balancercontroller deployment related pods is able tocreate this AWS application load balancer.Without any authentication, it's not possible, right?So it need to have some authentication mechanism.So that authentication mechanism is nothing but herewhatever the token you are seeing.So using this token and it will be able toauthenticate to those respect to APAsand then create the application load balancer for us.So now let's come back here and where are we?So this is the one, right?So we have seen these things and if you see in thedeployment also we have seen the service accountand in pods also we'll find the service account, right?So if you go there and you'll find something calledin the volumes also you'll find the AWS IAM token.All these things you can see in detailif you run this command, right?So if you say kubectl get pods. (typing)Already for the deploymentyou have seen the service name,AWS load balancer controller.But for the load balancer controller pod spec,if you review you'll understand more and more here.So we can take these things and say kubesystemand this is the pod name we want, right?So copy and this is the pod name, right?So copy this pod name and(typing) -O YAML.And then you'll get the complete pod specification hereand inside that spec.volumes.name.So if you go and then verify the volumes here, right?You'll find something calledthis respect to pod spec volumes.So you're going to find this one,service account token audiences sts.amazonaws.comand if the path is going to be tokenand it is going to bethe name of that token is going to be AWS IAM token.So let's find those things.So we'll copy this to oursomething like our any of the file here and then search it.So let me copy and come back to the visual studio core here,remove these things, and...now remove the first line here, whatever we have added.And come down and remove the last line(indistinct) MacBook Proand search for AWS-, IAM- token, right?And you'll find inside the podsinside the pod spec volumes AWS IAM token andwhich is using that token here and this pod is token.So now let's search for those things.So you can see in the volume mounts you'll findthe mount pod, AWS IAM token.And in our easy two instances, in value and secrets,in so and so location, and service account,you'll find this IAM token.And in addition to that,we'll also find token here.Token and we need to find hereAWS - this is the environment file web identity token file.And in service accountthis is the path token path here value, right?So this path we are picking here in detail.So let's come back here.So spec volume name, we have verified thisand we'll go to volume mounts and we have verified this.And in web identity token also you'll find.So these, all these things, if we put them togetheryou'll understand how the values are mountedto your pod inside load balancer controllerso that the application presentinside that load balancer controller,which is load balancer controller application,is able to authenticate (indistinct) AWS APAs.we can understand in detail.But these are only for ourinternals understanding how things are mounted andall those things.So in addition to that you have something called"verify TLS search for AWS load balancer controller".So these are the TLS search which we have seen earlier.So whatever this token, whatever you have seen isdirectly related to your load balancer controller, right?So which means like,for your load balancer controller related service accountthe secret mounted to it, that one we have seenas part of step 0-4-0-5, right?But when you go to step 0-4-0-6you'll find something called"verify TLS search for AWS load balancer controller"So this is the one we are discussing now,AWS load balancer TLS.So this is the secret.So we have the 9-4-4-3 pod, which is a SSL pod running here.So for that the certificates you are going to takefrom this AWS load balancer TLS secrets.So you can go here and then get the output of thiskubectl- and kubesystem, get that secret,which is AWS load balancer TLSand you'll find the TLS key and then TLS certificate.So we'll take the certificate and then decode it and thenunderstand in detail.So let me copy it here and go hereand remove this and paste it here.And then decode, soNo, no, let me remove this.I'll just say base64 decode.Let me close these things and this is the certificate.And I'll say decode and you got the certificate here, copy.And I'll say SSLs checker cert decoder,and decode this certificate.And you'll find something here.The common name of this certificate isAWS load balancer controller.So the WebHook service, right, is listening on 4-4-3,and load balancer controller is listening on 9-4-4-3.And these needs these certificates, right?And the SAN certificate names for these things,AWS load balancer, webhookservice.kubesystem,and AWS load balancerwebhookservice.kubesystem.svc.So these are the additional SAN names availablefor this respect to certificate.So that's it.So this is another additional informationwhich we need to understand about port 4-4-3and then port 9-4-4-3 for serviceand ports for the AWS load balancer controller.So if you open it and then see it in detailif you want to go to that load balancer controller partand go to the volume mounts and verify the mount pathfor serving such there, and also verify the volumesyou'll get the additional understanding about those parts.We really don't need to worryor go in this deep for this respect to thingsbut for additional understanding,it is always good to know more, right?So that's the reason this 0-4-0-5 isalways optional for you,but I have put them for additional understanding.So I'll see you in the next lecture.Until then, bye bye.Thank you.So before going to next lecture, so this is step 0-4-0-7which will help us in uninstallingthe AWS load balancer controller.Help, uninstall, AWS load balancer controllerfrom namespace, kubesystem.So this is optional, we are not going to use itbut just for additional reference I have put it here.So I'll see you in the next lectureand discuss about the Ingress class concept.Until then, bye bye.Thank you.
# 24.11 Step-11- [NEW] Deploy Stage- Review buildspec-deploy.yml

Instructor: Welcome back.In this step,we are going to review the buildspec-deploy.yml.So, as part of Step-07,we are going to implement deploy stage,or deploy phase in CodePipeline.And first, we'll review the buildspec-deploy.yml file.So, we'll go to Visual Studio Code hereand this is the buildspec-deploy.yml.Here also, you have and in 11-NEW in GitHub files also,you'll find the buildspec-deploy.yml.So, let me go here.And then, you can see, its version is 0.2.And in the environment variables, right,so we have defined two variables,one is EKS_CLUSTER_NAME.So, you need to also update this here.What is your EKS_CLUSTER_NAME?Provide that here.And in EKS_KUBECTL_ROLE_ARN, soon in the next steps,we are going to create this role.And here, this will be your account ID, right?So, if you name your role as same, this way only,you need to update the account ID.But if you create a different role name,so the complete ARN of that role,we need to update it.So, these two are the things,which you need to update as per your environment.And after that, we'll come to the phases.We have install, pre-build, build and then post-build.So, we'll start with the top, install.There are no dependencies here, so we leave it as is.We are not going to install any dependencies.And in the pre-build phase, right,so, we are going to fast get our IMAGE_URIand IMAGE_TAG, which we have savedin exported-vars.env file.And then, we have presented it as artifactsin the build phase.So, you can see it here.You have exported itand then, put it as artifacts in exported-vars.env,which means in the other stage also,you'll find that fileand then, you'll source that fileand get the IMAGE_URI and IMAGE_TAG valuesfrom that exported-vars.env, right?And once you get that IMAGE_URI and IMAGE_TAG,you are going to update the container imagein Kubernetes Deployment YAML file,which means in kube-manifests folder,you have the deployment file.So, this container image,you are going to change it to this one,which is nothing but what is IMAGE_URI and IMAGE_TAG.So, this container image will be automatically replacedwith whatever we have created,means like our IMAGE_URI and IMAGE_TAG is nothing,but whatever it has been noted in the build phase.So, that's what it is going to dowith this sed command and all these things.So, you can see it is referencing replace CONTAINER_IMAGEwith IMAGE_URI:IMAGE_TAGin the file 01-DEVOPS-Nginx-Deployment.yml,which is present in kube-manifests folder.So, that is one thing it is going to do now.So, this is a thing.So, what we are doing,is we are going to faster nothing in the install phase.And in the pre-build phase,we are going to get the IMAGE_URI and IMAGE_TAG valuesfrom exported-vars.envand update the 01-DEVOPS-Nginx-Deployment.yml filewith the IMAGE_URI and then IMAGE_TAG.And after that,we are also going to do a cat of that file,so that whether the change happened or not,we can verify in our deployment logs.So, that's about pre-build phase.In the build phase, right,the commands here are we are going to assume IAM roleto gain temporary credentials for kubectl access.So, how do you deploy these things, right?So, how do you deploy these kube-manifests?You run the command kubectl apply -kube-manifests.Before that, what we need to do?We need to configure the access to our EKS cluster.So, how we are going to do that?With command aws eks update-kubeconfig --nameand then provide your EKS_CLUSTER_NAME.So, $EKS_CLUSTER_NAME.So, it'll get the cluster name configured in this variable.But important thing,so very important thing here is, right,the build docker imagewhere this build is going to run, right,so, it needs access to AWS Cloud EKS cluster,hosted on AWS Cloud.So, how we are going to do that?We need to create a temporary credentialsfor kubectl access.So, we are going to create a IAM role,which will have access to EKS clusterand we are going to configure it as a assumed role.So, we are going to configure that IAM role as a,we are going to assume that roleand generate the credentials, temporary credentialsfor some duration, some 900 seconds.And then, using those credentials,you can configure the kubeconfig,means like access to your cluster.And after that, you can deploy these Kubernetes manifests.So, for that purpose,you need to create this STS AssumeRole and IAM role,all those things you need to do.And these things, you need to attach itto your CodeBuild service role.So, all those things, we are going to do in our next steps.But in the build phase,what we are doing is we are going to assume the IAM role,update the kubeconfig and apply the Kubernetes manifestsand then, verify whether the rollout happened successfully,or not.So, these things, we are going to do in build phase.And in the post-build, means like after the deployment,we are going to verify if pods are running,services are running and Ingress is running or not,we are going to verify using kubectl get pods,get svc and get ingress commands, using these things.So, that's about this buildspec-deploy.yml.So, in our next lecture,we'll focus on implementing other steps relatedto deploy stage.I'll see you in the next lecture.Until then, bye-bye, thank you.
# 22.10 Step-09- NLB Fargate Demo with Target Type IP

Welcome back. In this demowe are going to send the trafficcoming to the network load balancer to aworkload that is running on Fargate in EKS cluster.So for that purpose, the changes includedin the Kubernetes load balance serviceof type network load balancer isthat target type.So we need to change the target type annotation to IPso that it can send that traffic to theports running on the target infrastructure.So here the target ports are going to be registeredwith pod IPs as the targets in the target groupof this network load balancer.So now let's also understand that this respective S appthree related ports will be scheduled on targetnotes. Let's understand the Network architecture forThe same thing.So as usual in AWS cloudwhenever we created the EKS cluster control plane UsingEKS CTL So equivalent VPC public and private subnetsare created.AndNow we are also going to create a Fargate profileand this Fargate profile right inside this Fargate profilewhenever we deploy the workload so automaticallyit'll create the Fargate notes for us.So how many pods we create.So those many number of Fargate notes will be created.And another important thing we should be awareof is whenever we schedule a pod on a Fargateinfrastructure, we need to ensure that pod initiallywill be in the pending state and it'll take threeto five minutes or two to three minutes toInitialize all the Fargate notes and then change the podfrom pending to running state.Unlike regular EKS worker notes, the time taken toinitialize the Fargate scheduled pod is going to be a littlebit more.So when you see it is in the pending stateinitially we really don't need to worry.So we need to wait for two to three minutes for the Fargatenotes to get created and registered with the EKS clustercontrol plane and then ready to accept this part tobe running on those respective notes.And these Fargate notes also will be in communicationwith the EKS cluster control plane in using theNAD gatewaysand the Kubernetesservice of type network load balancerwill be deployed and as usual it'll have the standardfeatures of tls, external DNS, all those thingswhich we have already demonstrated in our previous sections.Only change here isTarget type annotation is going to be changedfrom instance toIP.So rest all is going to be as is.SoOnce that is implemented, the trafficfrom the network load balancer will be directly goingto the ...port IP.So now let's see theexact annotation change.So AWS load balancerNLB target type earlier it used to be instance.So now we are going to change it to go backto our GitHub repository and we arein section 19 0 6 LBC NLB Fargate external.So which means we are going to implement NLB networkload balancer internet facing.So as part of introductory section we already understoodabout what we are going to implementas part of this demo in step one.So now we'll go to step zero twowhich is review the Fargate profile which ispresenting Fargate profile folderinside that zero one Fargate profiles dot com.So let's go to our visual studio code and we arein section 19 0 6 LBC NLB Fargate external.and in Fargate profile folder you'll find somethingcalled zero one Fargate profiles dot aml.So here you are creating theFargate profileof whose name is F P app threeand the workloads that are going to runon Fargate will be using the name space NS hyphen app threewhich means any deployment whatever you are going to deploywhich is nothing but Kubernetes deploymentif it uses the name space NS app threethen the ports related to the deployment will be scheduledon this respective to Fargate profile.So that's the understanding about why we are mentioningin selectors the name spaces NS app three.So now let's come back here.If you see here the changes from your infrastructureit is going to beif you are EKS demo one will be your cluster nameno changes, our region is US east one, no changes.Put your exact cluster name where you want torun this Fargate profile and also the region.Now let's come back hereand create this respective Fargate profile.So to create a Fargate profile.So we need to go into 19 0 6 LBC, NLB, Fargate external.So let's come back to terminalwe'll go to 19 0 6 LBC NLB, Fargate externaland we'll create EKS CTL create Fargate profileand provide hyphen F andthat profile where it is located, the AML file.So we'll copy this and we will paste it here.So it'll take three to five minutes tocreate a Fargate profile.So let's wait for the profile to get created.We can see here our Fargate profile FP app threeis created now.So now let's go back to our reportand we have completed step three just now.So we'll moveon to step zero four which is update our annotation relatedto NLB target type.In addition, we'll also review the cube manifests here.So let's come back hereand let's start with ourtarget type nlv.Target type S IP.So this is good and another important thing iswe need to review all 0 0 0 1 engine zero two cube manifest.So starting with zero zero name space dot yamlwe are going to create a name space NS app three.So why we are creating this name space related resourcebecause anything with the any workload deployedin that respective namespace NS app three will be scheduledon the Fargate profile FP app three.So our Kubernetes app three pod should be scheduledon the Fargate profile sothat we will be able to test that network loadbalancer target IP equal to IP, right?So target IP equal to IP.So now we will first create the NS app three namespaceand in engineers app three deployment in the metadatain namespace we will provide NS hyphen app three.So which means this deployment will be scheduledon this respective namespace andinside this only the respect your parts relatedto app three engineers will be createdand we'll also go to NLB load balancer serviceand this load balancer service which is networkload balancer also will be createdin the namespace N S app three.So inside this alsoin metadata we'll add the namespaces NS app three.So now let's come back to working.So we have reviewed both the things.So now we'll go ahead and then deploy all cube manifests.So we'll go tocube CTL,apply hyphen Fand cube manifest.So this should create a namespace NS app threefor us and also create our the deploymentand also... NLB related servicefor Fargate, alsoon the NS app three namespacecube CTL getpods will give the pods from the default name space.So we need to get the partsfrom the name space hyphen NS app three.So we will see the partsin the NS app three and app three engineers deployment isin running state so which means clearand we will also see Q CTL get notes and hyphen wide.So this should provide the notes regular two worker notesand also one more Fargate note for us.So we can see here these are our regular twoworker notes which we have createdas part of EKS private note group.And this Fargate note also got createdand automatically the respective parties are runningon this respective Fargate board.If we want we can also add one more replica here, right?So and I will say cube CTL apply hyphen F cube manifests.Let's see what happens before going to the service.So it has configured app three engineers deployment.So I'll say Q CTL get ports and hyphen N NS app three.So you'll see that currently initially the port isin pending state until the Fargate note is scheduled.So if you see QCT get notes hyphen oh wide.So one the next note is also ready nowand we will see what happens right?Get ports hyphen NS app three.So from pending state it'll go to the running state.Once the new Fargate note is ready currently onlyone Fargate note is there.So initially it'll first create the Fargate note andon that Fargate note it'll schedule this respectivenew replicaof app three.So that's the reason initially it is going to bein the pending state and slowly it'll move to running state.So we need to give one minuteto three minute buffer time for the Fargatenote to get created and that need to be registeredwith the EKS cluster control plan then onlyKubernetes API server can schedule the Fargatethe app three engineer part on this Fargate note.So let's wait for it to into the running stateso we can see the second part is also in the running state.So now let's go back here and verify the services now.So we'll go here Cube CTL getSVC and hyphen N NS app three.So you should see herethat from namespace app three NS app three youcan see your Fargate LDC network LBS created.So now we can copy thisand go to the browser and then access it.So if, if it isin the active states it should be working for us.So let's refresh here in our load balances and it isin active state so let's wait for the response to come back.In meantime we can also verify the target groupsand go inside the target group,any of the target group.Why? Because we are using port 80 and 4 43 communication.So it'll create two target groups.So we'll open one target group hereand you can see one is healthyand the other one is initially health checksin progress and it is refreshingso it is trying to also register the second portwhatever we have created two replicas we have createdright? So now let's come back here.Cube CT, get ports hyphen O wideand also provide the name space hyphen N NS app three.And here we are going to verify the pod IPs.And for these two pod IPs we can see one 90 to168, 67 to 53and 80 to 81.So if you see here 67 to 53, 80, 81.And if you go here and also verifyso it is using the target type IP andif you go inside them also you are seeing the podIP addresses directly getting registeredfor our target groups here as targets.So which means whatever we have implemented herewhich is nothing but target type as IP is successful, right?So now the trafficfrom the network load balancer is directly sentto the port IP scheduled on theFargate infrastructure.So this is also accessible and working.This is HTTP URL and we'll also copyand then get the HTTP URL also.So we'll copy this and also test the HTTPS tool.Let me copy this and go hereand say HTTPS colon slash slashHTTPSand we can see here it is accessibleand also see the DNS name here, which we are usingwhich is NLB Fargate 9 0 1.So let's access using that one alsowith HTTPS and it should also be accessible for us.This completes the demo relatedto creating a network load balancer with the target typeas IP and then sending the traffic to thepods scheduledon the Fargate infrastructure from network load balancer.So now let's go ahead and then clean up the stuff now.So we'll go here and cube CTLdelete hyphen F cube manifest.So this should delete the both the thingswhatever we have createdwhich is LBC related network load balancerFargate LBC network lband also app three s deployment and also the name spacewhatever we have created, which is NS app three.So once this is deleted we also need to cleanup the Fargate profile.So for that first we can list it the Fargateprofiles using EKS CTL get Fargate profileand in cluster EKS demo one.And after that you can run the EKS CTL deleteFargate profile with the name of my Fargate profile.So let's wait for this.And now if you see Cube CTL, and if you say get NSwhich is name spaces, you should not find any name spacewith name NS hyphen app three.Only you should find that default name spaceand cube note release cube public and then cube system.So now let's come back here and say EKS CTL,get Fargate profile from the cluster EKS demo one.After that we'll go ahead and then delete that.So this is the FP app three related profilewhich we want to delete it.So let's come back here, copy this command and delete it.So it'll take another three to five minutes todelete this respective profile.So let's pause the video.Until then, we have also deleted the Fargate profile.Whatever we have created, I'll see you in the next lecture.Until then, bye bye.Thank you.
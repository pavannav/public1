# 24.10 Step-10- [NEW] Build Stage- Update CodeBuild Role and Run pipeline and verify

Instructor: Welcome back.In the previous lecture,we have created the CodePipeline for Sourceand then Build stages.And in the Source stage,you can see we have the Base Commitin our GitHub repository and that it took itand then Source has run successfully.And then in the Build phase, it failed.Okay, so now we'll go to the CodeBuildand go to this build-eks-devops-551.And then if you see the Build history, right?So if you try to open this Build, right,and we'll see what happened.Okay, so these are the Build logs available here.And if you go down here, right,so it is saying that it is trying to run all the commands,whatever we have inside this buildspec-build.yml.So you can see it here,Entering phase INSTALL phase, okay?So in the Install Phase, Nothing to do using latest,so that you can see it here, okay?And it entered the PRE-BUILD phase.And in PRE-BUILD phase, it has run the IMAGE_TAG thingand exported the IMAGE_TAG and it logged into the ECR also.So everything is fine.After that it has run command aws ecr get-login.So it is trying to run that.And it says that AccessDeniedException.It doesn't have access to ECR to login.So, what we need to do?So, we need to do is update our CodeBuild Role.So, this CodeBuild whatever we are seeing, right?This is the CodeBuild projectif you try to open that project now.So this is the Build projectand this is the build-eks-devops-551.And this is the service role of that project.I'll try to open in the new window.This is the IAM service role.So this service role doesn't have access to ECR.Okay. Elastic Container Registry.So we'll try to give the full access to that ECR.In addition, we'll also try to giveCloudWatchLogsFullAccess, okay?So both things we are going to do now.So we'll go to this codebuild-eks-devops-551-service-roleand we'll try to add Attach policies.So one policy which we are attachingis AmazonEC2ContainerRegistryFullAccess.That is one we are going to add.And another one is CloudWatchLogsFullAccess.So these two things we are going to add.And now you can see those two things should be added.So that's the key thing.Now, let's go ahead and then run,commit the code one more timeand then see what happens.It need to get the new source codeand it need to run the Build for us.And then it need to also create a Docker imageand push it to ECR.So let me also open the Elastic Container Registry hereand then Elastic Container Registry.So if you go to the repositories eks-devops,currently no images present.So we'll go back to our aws-eks.So we'll go to the Terminal here we are in aws-eks-devops.And inside this you have in app1 index.html.So it'll go here. Right.So in app1, this is aws-eks-devops.And inside that you have the index.html.I'm just changing it from this static index.htmlfrom V1 to V2.And then I'm in the same folder here.If I say git status,it is saying there is a change in index.html.So I'll say git commit -am,and I'll say V2 is the version currently, okay?And then git push. Okay, so let's see what happens.So it is a V2 and I have said I have pushed it.Now, if you come back to our repository here, right?So it is like, now it is V2.This is the code b998dd2 is the thing,and V2 is the commit we have done.And now, if you come back to the pipeline here, right?So this pipeline should be running now, see?Now, the source it is taking is V2 version.You can see it here clearly.And the Build started running, okay?So we'll go here and verify the Build logs now.So we'll go back here and go to build-eks-devops-551.And this is the third build. Okay?And let's see what is happening here. Okay?And it is saying that,"Unexpected status code Docker registry.You have reached the unauthenticated pull rate limit."Increased rate limit, something it is throwing the error.That's fine.If the stage is failed,we also have a retry one more time,which we have set up in the CodePipeline.So it has retried one more time, right?And it's a minor thing. Okay?So now, let's come back hereand automatically it has retried the Buildand now it has passed successfully.So you can see it here,Running command aws ecr get-login-password.And here the authentication is successful.Configure a credential.So your password will be stored unencryptedfrom and so and so and so and so.But this is the important thing. Login Succeeded.And once the login is succeeded, what we are doing hereas per the buildspec-build,so we need to go ahead and then build the Docker imageand push the Docker image.So those things are happening or not we are seeing,so it is going to build the Docker image.Now, these are the steps to build it.So it is building the Docker image.And once the Docker image is built,entering into POST_BUILD phaseand it is trying to push the Docker image.So this is the Docker image it is trying to push.It pushes the Docker image.After that it is also creating a exported-vars.env file.And then finally, Build is completedand also it uploaded all the artifacts also.So all those things completed successfully.Expanding exported-vars and all these things.And then finally, it is completed.Now, if you go back to Elastic Container Registry hereand refresh, you have the image, right?Docker image createdand whose image tag is b998dd2.And if you see it here,the commit code for V2 is also b998dd2.So we have successfully completedthis part here in the pipeline.So, if you go to the pipeline here,so what happens, see, both things are completed.Source and Build phases successfully completedand they are in green now.And we have also verifiedthe Docker image in container registry, right?In our next lecture, we'll focus on Deploy stage.So I'll see you in the next lecture.Until then, bye-bye. Thank you.
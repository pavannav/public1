# 22.2 Step-01- Introduction to Network Load Balancer with k8s Service

-: Welcome back.In this section we are going to implementAWS Network Load Balancer using Kubernetes serviceand AWS EKS Load Balancer Controller.So so far whenever we have implemented it in section seven,it is with the AWS cloud provider Load Balancer Controllerwhich is a legacy one.So now, AWS has provideda dedicated load balancer controllerwherein with that you'll be able tocreate Application Load Balancerand Network Load Balancer.So let's see how to createthis Network Load Balancerand a little background about all these things in detailbefore going into practical implementation.So what is a Network Load Balancer?So network traffic is load balanced at layer fourof the OSI model.And this Network Load Balancer supportsPCP. UDP, and then TLS protocols.So if you want to understand moreabout this Network Load Balanceror Application Load Balancerand understand the differences about them,are the types of services they provide,are types of features they provide.So this is the ELB features comparison linkand we can go there and then review them in detail.So if you see here, in AWSwe have Application Load Balancer,Network Load Balancer, Gateway Load Balancerand Classic Load Balancer.So out of which, the load balancer type is layer sevenfor Application Load Balancer.And now the item which we are discussing hereis Network Load Balancer and that is of type layer four.And Gateway Load Balancer can do layer three gatewayplus layer four load balancerand Classic Load Balancer is of type layer fourand then layer seven which is the legacy one.And in future it might get deprecated too.So the important thing here isif you review all these features,so in the Network Load Balancer, you can see thereis no layer seven related featuresbecause it operates at the OSI model layer fourand there will be some common configurations.Those are supported in this Network Load Balancerand also from Kubernetes perspective, right?So it also supports SSL offloadingwhich means it also supports the TLS terminationon the Network Load Balancer itself.From Kubernetes perspective you can seeit also supports the Fargate partsand also it supports the fully private EKS clustersand it doesn't support the load balancingto multiple name spaces.Here Application Load Balancer supportsthat which means ingress supports that.But Network Load Balancerwhich we are going to createusing Kubernetes service resourceis not going to support that.So now let's go back hereand understand more about these things.So options for creating Network Load Balancerusing Kubernetes on EKS cluster.So what are the options?So we have two options.So one is AWS cloud provider load balancer controllerand another controller is AWS Load Balancer Controller.And if you see thisAWS cloud provider load balancer controllerit is a legacy controller which cancreate AWS classic LB and network LBbut the latest one, right?So this AWS Load Balancer Controller cancreate latest and greatest,which can create AWS ELB and NLB.And this cloud provider load balancer controller isa very basic Network Load Balancerand this controller will receive only critical bug fixesand in long run it will be deprecated andthis controller will not have any new features added to it.So that saidso this AWS cloud provider related load balancercontroller is going to be of no use for us.So we need to learn the Network Load Balancercreation using the AWS latest Load Balancer Controllerso that it will be very helpful for usIn that line I have ensured thatsix demos were created using this Load Balancer Controllerand Network Load Balancer with Kubernetes service.So now if you see here in section seven of this courseyou'll find something called 07-02-Classic-LoadBalancerand 07-03-Network-LoadBalancer.So these two things were created usingthis AWS cloud provider Load Balancer Controllerand this controller you don't need to specifically go aheadand then install it.So by defaultso whenever the EKS cluster control plan is getting createdso that will be installed automaticallybut when coming to this latest AWS Load Balancer Controller.So you need to specifically go ahead and then install it.So we have done that when we have implementedthe Application Load Balancer ingress concepts.So now in our cluster we already have the AWS loadbalancer controller and also the external DNS related portsand all those things.So that said, these demos we are going to doafter the ingress related demos, whatever we have doneas part of section eight newand also section nine which is Fargate.And after that we'll do this section 19.And if you see here this Load Balancer Controller rightwith the Network Load Balancer, which meanslike whenever you are-This Load Balancer Controllerwhatever we are talking is like we are talking hereabout the Network Load Balancer features.So this Network Load Balancer supports PCP, UDP, and TLSand for health check also it supports TCP history.TPN has GTPS related protocolsand this Network Load Balancer in combinationwith this Load Balancer Controller also supportsinstance and IP mode.And for IP mode is primarily for Fargatebut you can also use itwhen you're using the worker nodes also, right?So that the requests will go directlyfrom your load balancer to your respective port.And this Network Load Balancer also supportsinternal load balancer and also external load balancer.In addition to that it also supportscustom subnet discovery.So which means you can define custom subnetsby annotation itself and this Network Load Balancerin combination with this Load Balancer Controller alsosupports static elastic IP and also access controls.All in all with this new approach,we have 25 plus new annotations available for usand we can use all those annotationsto effectively configure our Network Load Balancerand use all the latest features of our Network Load Balancerfrom Kubernetes service manifest itself.So if you go to that link here, whatever is provided, right?So earlier we have seenthe ingress annotation specificationsand these are ingress related things in the guide, right?So you can see here in the serviceyou'll find NLB related informationand also NLB related annotations.So all these are the NLB related annotationswhich we can use to configure our Network Load Balancerwith the features inside those things.So there are close to 25 plus annotations available for us.So now let's come back here.And another question we have here is howto ensure our network will be createdusing Kubernetes service will be associatedwith only latest AWS Load Balancer Controller.So the question here is you have createda Kubernetes service of type LoadBalancerwith an annotation related to Network Load Balancer.So how will we know thator how will we ensure that the load balancerwhatever it is going to create the network loadbalancer is associated or is reconciledwith the AWS Load Balancer Controller, the latest one.So here comes the important thing.So you have return your Kubernetes service manifestand you also have your AWS cloud provider loadbalancer controller, which is a legacy one bydefault whenever you create a EKS cluster control plane.So that gets installedand now you also install your AWS Load Balancer Controllerwhich is the latest one.So now here comes the important thingin the Kubernetes service manifest.So whenever you define your annotationas annotation for AWS load balancer type as NLBRight? So whenever you define that as NLB sothat Kubernetes service will be associatedwith this legacy cloud provider Load Balancer Controller.And whenever you define, right,AWS Load Balancer type as "nlb-ip"or external, when you define these two thingsit'll be associated with the AWS Load Balancer Controller.So if the values of AWS load balancertype annotation is nlb-ip or external,at that point of time-This legacy controller ignores that Kubernetes manifest.So that AWS Load Balancer Controller can take over that.So that's the thing happens in the background.And so this nlb-ip is far-This Fargate related ports andthis is a deprecated one and just still in actionfor backward compatibility.But the standard one which always we needto use the AWS Load Balancer Controller,the latest one,is use the load balancer type as external.So all of our demos, all the six demos relatedto this Network Load Balancer, we are going tohave this external as the load balancer type.And don't confuse that whenever you put the typeas external, it is going to create any internetfacing load balancer.So that decision will be taken with it differentannotation call scheme.But here this type is nothing butit is not using the internal by default installcloud provider load balancer.It is using an external load balancer controller,which is nothing but whatever you have manually installed,the latest AWS Load Balancer Controller.An additional note too is EKS cluster versionsso and so, right?V1.18.18 plus RV.19.10 plusand V1.20 or 21 or 22.Any, anything higherare supported with this entire features.So which means from these versions onwards,whenever you use the type as external or nlb-ip,then your Load Balancer Controller latest will be picked.So now let- why?Because they will have a patch applied to this cloudprovider load balancer so that whenever the requestwith this Kubernetes manifest whenever deployed, right?First this cloud provider Load Balancer Controllerlegacy will check for the load balancer type.And due to that patch it'll verifywhether it has nlb or nlb-ip or external.And if it finds that anything from this nlb-ip or external,it will ignore and not create the-Not associate or reconcile with this one.And at that point of time automatically the new loadbalancer controller will take the action and then use it.So now let's come back here.So from Kubernetes service manifest perspectivethe important items for creatinga network load balancer which will be associatedwith this AWS Load Balancer Controller latest isKubernetes services are Kubernetes object of type service.So this is one settingand another setting is load balancer type is external,right?And your type means like your load balancer typeis LoadBalancer in your spec.And also you can have the load balancer scheme.You can see the scheme here, right?So it can be internal internet facing or internal.So if it is internal it'll create the internalNetwork Load Balancer.If it is internet facingit is going to create a internet facing load balancer.But key important things are your Kubernetes object of typeor object of kind serviceand your load balancer type is externaland your service type is LoadBalancer.In these cases, it is going to createa network load balancer which will be associatedto your AWS load balancer console or a controlleror it is going to reconcile with AWS load balancer control.Now let's see the high level architectural object viewof what is this from Kubernetes perspective.So we have- in AWS cloud we have created a EKS clusterand we already installed the AWS Load Balancer Controllerwhich means its related service accountsand IM roles all are createdas part of our ingress first section, right?So that's good.So now let's come back hereand if you see whenever you deployyour Kubernetes manifest of type serviceso automatically initially it'll check meanslike it'll go and then check next yours cloud providerload balancer, legacy controller.And there it finds that the load balancer type is externaland at that point of time this Load Balancer Controllerwill pick it and this Kubernetes service will be createdand reconciled or associatedwith this Load Balancer Controllerand the settings inside this Kubernetesload balancer services.Before going there we'll also go hereas part of deploying the Kubernetes service manifest,we'll also deploy our NGINX app related deployment manifest.So it'll create a NGINX app related deploymentengine port objects in our EKS cluster.So no from settings perspectivein Kubernetes service, right?So listener port 80 is going to be by defaultwe don't need to define any annotation for that.So it's a default oneand LB type external our load balancer type external.So this is the one which is deciding thatthis Kubernetes load balancer service should be reconciledor associated with this AWS Load Balancer Controllerinstead of a legacy one.And the next annotation you're going to define istarget type is instance.So either you can use instance RIP modeand we will do with instance modeand for a Fargate demo we'll do with IP.But you can use any of those things.Instance or IP mode.So with instance mode it'll use the worker nodes will bewith worker nodes with the node port serviceswhich means worker nodes related node port will be addedas a targets in your target group of your load balancer.So which we already discussed multiple times these things.And you can also define health check settingsfor your respective Network Load Balancerfrom the Kubernetes service itself.And the important option we have is it supportsboth TCP history, TP and historyTPS load balancer related health check settings.Even though this is a layer four load balancer,Network Load Balancer,and it operates at the layer four of the OSI model.The health check parts supports layer fourwhich is TCP protocol and also HTTP protocol,which is layer seven, and also HTTPS protocol.So that's one important thing we should know here.And scheme-this load balancer is going to be internet facingand also source range also you can definewhich means this network load balancercan be accessed from which places.And you can define that, you can restrictso I have put it to the full internet,but you can restrict and tell that we can allowthis network load balancer even if it is internet facing.So it can be allowed only from so and so IP segment.So that also you can doand whenever this Kubernetes service is deployedit creates the Network Load Balancerfor us from AWS cloud perspective.But this is a single object for us to understandfrom logical perspective.And whenever user accesses the NLB DNS URLwhich is a HTTP URLso the request comes to your app Network Load Balancerand from there it'll go to your app three.And that happens with this services there like thesethe targets are registered as a node port services, rightin your respective target groups of your load balancer.So now the same thing we have seenin a Kubernetes object model.So let's also seefrom AWS network design perspective in AWS cloud.So whenever we have created EKS cluster control planso it has created public subnets,private subnets, and also a VPC for usin two availability zones.Later it we have alsocreated a EKS private node groupas part of our section 07-01and we also have a NAD gateway automatically createdfor outbound communication for our worker nodeswhich are present in the private subnetswith EKS cluster control plan.And we also deployed our NGINX app three.So this should be changingto app three here, but that's fine.So it which will create a deploymentwhich creates a replica set and their ports inside them.And we'll create a Network Load Balancerwhich means you have deployed a Kubernetes service manifestand it created a Network Load Balancerfor us and as users, right?So whenever you access your HTTP and LB DNS URLso it'll come to your Network Load Balancer and why right?Worker node related node ports, it'll reach your pod, right?So that's what it is going to happen.And finally, so these are the annotations which we are de-which we are going to define as part of the NLB basics demo.So these things one more time we are going to reviewin detail in our next step in our visual studio code.So I'll see you in the next lecture.Until then, bye bye.Thank you.
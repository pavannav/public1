# 24.14 Step-14- [NEW] Deploy Stage- Update aws-auth configmap and create STS policy

Instructor: Welcome back.In this step, we are going to updatethe AWS auth config map in Kubernetes clusterwith this IAM role, whatever we have created.So why do we need to do that?Why, because you have created a IAM role here.STS assume role,but you also need to configure it in AWS auth config mapin EKS cluster so that anyone who assumes this IAM role,right?So we'll be able to, whoever assumes thisEKS code built cube CTL role, they'll get the accessto EKS clusterand to what level the access should be granted alsowill define in this AWS auth config map.So that is the key thing.So you need to be in this 11 new DevOpswith so and so folder,and we already have the AWS auth folder present there.So in very simple terms, this grants the role accessto EKS cluster, which is required for Kube CTL commands,right?So these Kube CTL commands, we are goingto run in the deploy stage from CodeBuild,and when CodeBuild assumes that role, we need to get accessto EKS cluster to deploy those Kubernetes manifest.So that we are going to do now here.Also, we have for Mac OS and also Windows PowerShell.So we'll try with Mac OS now.The first thing is set the variables here.So I'll try to set the variables, and account ID is done,and if you want, you can verify your account ID here.And next is this is your role,whatever we have just now created, okay?So let me copy this and run it,and echo dollar, role ARN.and this is the role ARN you have got, and let me copy it,right?And if you go back here to your role,and try to search for it, right?If I say control F, and if you search for it,So this is the role ARN, it is good.This is the one you need to put there.Okay, now let's come back here, and first, we are goingto back up the odd config map whatever is present.So if you are present, and so we'll go to AWS,EKS Kubernetes masterclass, and you need to be presentin 11 new DevOps with AWS developer tools in GitHub folder.And here, you'll find the AWS auth folder, okay?Now let's come back here, and before taking the backup,we'll review whatever is present inside this.So what is this command?Kube CTL get config map, and config map name is AWS auth,and where it is present, it is presentin Kube system namespace,and how you are going to output it?With YML format.So let's see what exactly it has inside it, okay?So it has something called,so this is the data in map roles.You have its own, one of the role ARN is added it here.So this role ARN is related to your node group, EKS, CTL,EKS demo one, node group (indistinct), role ARN.So for this role, it has given the permission systembootstrappers, and system node permissionsin nodes permissions in EKS cluster.So that is the thing.So for us, what it is going to give,we are going to review shortly.And if you go back to here in the AWS app,I have the base file here.Okay?So this base file will be different for you and for me.Why?Because this is the default node,means like default node,whatever I have created, node group I have created,those related role ARN.For your node group, it might be your account ID,and the role it has created based on your EKS cluster name,it might be a different name.So this will be always dynamic.So this is just for reference only, I have put it.So whenever you want to update, it means like roll it backto your original version also,you need to get that role ARN of your node group,and put it here, and then say Kube CTL, apply hyphen F,and then AWS auth base.And then with this single role, I will be presentin your EKS cluster.So just for reference, I have put it here,but now let's come back, and then take the backup.So first we'll take the backup, right?I'll say clear, and I'll take the backup.And once I take the backup,if you want, you can review that here.This is the backup file, and all these annotationsand all these things you can ignore.But important thing is, in data map roles.So this is only one role ARN present, which has permissionto system bootstrappers, and system nodes.Now what we are going to do is,we are going to run this command.So which will generate a AWS auth patch dot YML.So what it is going to generate, we will see,and then review it.So we'll just run the command, and let it generate the file,and we'll go to that file okay?AWS auth patch dot YML.So this is the auth patch dot YML,and here, you can see it here, it is saying that it is goingto say role ARN, and this is the rolewhich we have created in IAM, and username is build.Your desired name you can give,but important thing is this one.Groups and system masters.So whoever assumes this role and try to connectto EKS cluster, they'll get the system master's permissionto do anything on EKS cluster.So that's what you are defining in AWS auth config map.So now let's go back and applythat AWS auth patch dot YML now.So let's come back here and apply that, okay?And now, if you go ahead and then verify your config mapvia YML, so you'll see both things, okay?Your earlier role ARN, which is related to your node group,and also this one, which is your Azure mode rolefor Kube CTL, right?So that one with system masters permission also,you have it.So which means you have successfully updatedthe AWS auth config map.So in our means, like the next step here is to move onto step 0706 wherein, update your CodeBuild roleto have access to STS assumed role we have createdusing STS assumed role policy, right?So without this, our CodeBuild means like,so far, what you have done is, you have created a IAM rolewith STS assumed role policy,and then you have created a...You have updated the AWS auth config map,but you still didn't integrate itwith your CodeBuild project, or deploy CodeBuild project.So how we are going to do that, so we'll go here,so we'll go to CodeBuild.So we'll go to developer tools here.And in that, if you go to, if you go to build projects,and in build projects,you'll find that deploy EKS DevOps 551,which is again, I'm saying all these things we are doingin that deploy stage are deploy phase, okay?So this is the deploy one, and here,this is the service role for it.So I'll click on that service role.So let this service role open.And this is the service role here.You need to attach that thing, okay?So we need to create a policy,and that policy we need to attach it here.So how we are going to create it, we'll go to IAM policiesand create a policy stating service is STS,and select AssumeRole in the right section of actions,and provide your EKSCodeBuildKubectlRrole ARN, right?And then save that policy with this sum name,and then associate that to your CodeBuild role,whatever we have created.So this is the CodeBuild role.So we'll try to forget about this CodeBuild rolefor a while.We'll go to policies here, and we'll create a policy, right?In the service, we are going to select the service as STS.This is the STS service we have created,and in the right section, we are goingto say assume role, right?And then in the ARN section,so we'll go back here and get EKS Kube CTL role.So this is the one, and we will provide that here, right?And this is the one.This is the complete role ARN,ARN of your EKS CodeBuild Kube CTL role.I'll click on add ARN, right?And I'll click on next.And in the next, we'll provide the policy name,so you can provide any desired policy name.So I'll say EKS CodeBuild STS assume role.So this is the policy name I'll give.This is the policy name with 551 as appended.I'll try to give, and click on Create Policy.Let me create that policy first.Now that policy is created.Now we'll go, we will close this,we'll close this, and we'll come back here.Okay, so this is the deploy EKS,we'll go to build projects again.And this is the deploy EKS, and this is the service role.Let me open here.This is the service role for deploy EKS DevOps.And here in the permission policy section,add, attach policies, and search for the policiesEKS CodeBuild STS assume role 551,which we have just now created, right?And add permissions.And now that is successfully added.So this completes all the steps required for deploy phase.In deploy phase, what all we have done.So let's reiterate one more timebefore moving on to end-to-end testing, okay?So what we have done is,we have reviewed the deploy stage,build spec deploy dot YML.After that, we have created the code pipelinefor deploy phase.Okay?So there, you have created the CodeBuild projectwhere you have specified build spec deploy dot YML there,okay?And then after that,you have also updated the code pipeline rolewith CodeBuild full access.And after that, you have also created a STS assume IAM role.And then you also updated the AWS auth config mapwith that IAM role,and after that, you have also created A STS policy,and that policy is referencingto this EKS CodeBuild Kube CTL role.And then this policy, you have associated to the deploy...Deploy phase, deploy stage related CodeBuild service role.So all these things we have done as partof this deploy stage.In our next lecture,we'll focus on test one end to end flow,we are going to test it.I'll see you in the next lecture.Until then, bye bye, thank you.
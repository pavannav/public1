Welcome back. This is part two of this lesson.
We're going to continue immediately from the end of part one
so let's get started. So the first step
is to shut down this instance. So we don't want to create
an AMI from a running instance because that can cause
consistency issues. So we're going to close down this tab,
we're going to return to instances, right click
and we're going to stop the instance. We need to acknowledge this
and then we need to wait for the instance to change into the stopped state.
It will start with stopping. We'll need to refresh it a few times.
There we can see it's now in a stopped state and to create
the AMI we need to right click on that instance,
go down to image and templates and select
create image. So this is going to create an AMI
and first we need to give the AMI a name. So let's go ahead and use
animals for life template WordPress and we'll use the same
for description. Now what this process is going to do
is it's going to create a snapshot of any
of the EBS volumes which this instance
is using. It's going to create a block
device mapping which maps those snapshots
onto a particular device ID and it's going to use the same
device ID as this instance is using.
So it's going to set up the storage in the same
way. It's going to record that storage inside the AMI
so that it's identical to the instance we're creating the AMI from.
So you'll see here that it's using EBS. It's got the original device ID.
The volume type is set to the same as the volume
that our instance is using and the size is set to 8.
Now you can adjust the size during this process
as well as being able to add volumes but generally when you're creating
an AMI you're creating the AMI
in the same configuration as this original
instance. Now I don't recommend creating
an AMI from a running instance because it can cause consistency issues.
If you create an AMI from a running instance
it's possible that it will need to perform an instance reboot.
You can force that not to occur so create an AMI
without rebooting but again that's even less
ideal. The most optimal way for creating an AMI
is to stop the instance and then create the AMI
from that stopped instance which will have fully consistent storage.
So now that that's set just scroll down to the bottom and go ahead
and click on create image. Now that process will take some time if we just
scroll down
look under elastic block store and click on snapshots
You'll see that initially it's creating a snapshot
of the boot volume of our original EC2 instance so that's the first step
so in creating the AMI what needs to happen
is a snapshot of any of the EBS volumes attached
to that EC2 instance. So that needs to complete first initially it's going to
be
in a pending state. We'll need to give that a few moments to complete.
If we move to AMIs we'll see that the AMI is also creating
it to is in a pending state and it's waiting for that snapshot to complete.
Now creating a snapshot is storing a full copy
any of the data on the original EBS volume
and the time taken to create a snapshot can vary
the initial snapshot always takes much longer because it has to take that full
copy of data
and obviously depending on the size of the original volume
and how much data is being used will influence how long
a snapshot takes to create. So the more data
the larger the volume the longer the snapshot will take.
After a few more refreshes the snapshot moves into a completed status
and if we move across to AMIs under images
after a few moments this too will change away from a pending status so let's just
refresh it
after a few moments the AMI is now also
in an available state and we're good to be able to use this to launch
additional EC2 instances. So just to summarize
we've launched the original EC2 instance, we've downloaded
installed and configured WordPress, configured that custom banner
we've shut down the EC2 instance and generated
an AMI from that instance and now we have this
AMI in a state where we can use it to create
additional instances so we're going to do that we're going to launch an
additional
instance using this AMI. While we're doing this I want you to consider
exactly how much quicker this process now
is. So what I'm going to do is to launch an EC2 instance
from this AMI and note that this instance will have
all of the configuration that we had to do manually
automatically included. So right click
on this AMI and select launch. Now this will step you through the launch process
for an EC2 instance. You won't have to select
an AMI because obviously you are now explicitly using the one that you've
just created
you'll be asked to select all the normal configuration
options. So first let's put a name
for this instance so we'll use the name instance
from AMI. Then we'll scroll down
as I mentioned moments ago we don't have to specify an AMI because we're
explicitly
launching this instance from an AMI. Scroll down
you'll need to specify an instance type
just as normal. We'll use a free tier eligible
instance. This is likely to be T2 or T3
dot micro. Below that go ahead and click and select proceed without a key pair
not recommended
Scroll down. We'll need to enter some networking settings so click on
edit next to network settings. Click in VPC
and select A4L-VPC1
click in subnet and make sure that
SN-WEB-A is selected
make sure the boxes below are both set
to enable for the auto assign IP settings
under firewall click on select
existing security group. Click in the security groups drop down
and select AMI demo-instance security group
and that will have some random at the end that's absolutely fine select that
scroll down and notice
that the storage is configured exactly the same
as the instance which you generated this AMI from
everything else looks good so we can go ahead and click on launch
instance. So this is launching an instance
using our custom created AMI. So let's close down this dialogue
and we'll see the instance initially in a pending state
remember this is launching from our custom AMI
so it won't just have the base Amazon Linux 2
operating system now it's going to have that base
operating system plus all the custom configuration that we did
before creating the AMI. So rather than having to perform that same
WordPress download installation configuration
and the banner configuration each and every time
now we've baked that in to the AMI
so now when we launch one instance, ten instances
or a hundred instances from this AMI all of them
are going to have this configuration baked in
so let's give this a few minutes to launch once it's launched
we'll select it, right click, select connect
and then connect into it using EC2
instance connect. Now one thing you will need to change
because we're using a custom AMI, AWS can't necessarily detect
the correct username to use and so you might see sometimes
it says root. Just go ahead and change this to EC2
hyphen user and then go ahead and click connect
and if everything goes well you'll be connected into the instance
and you'll see our custom kowsay banner
so all that configuration is now baked in and it's automatically included
whenever we use that AMI to launch an instance
if we go back to the AWS console and select
instances make sure we still have the instance
from AMI selected and then locate
its public IP version 4 address. Don't use this link because that will use
HTTPS instead
copy the IP address into your clipboard and open that
in a new tab. Again all being well you should see
the WordPress installation dialog and that's because we've baked in
the installation and the configuration into this AMI
so we've massively reduced the ongoing efforts required to launch an Animals
for Life
standard build configuration. If we use this AMI
to launch hundreds or thousands of instances each
and every time we're saving all the time
and the effort required to perform this configuration
and using an AMI is just one way
that we can automate the build process of EC2 instances within
AWS and over the remainder of the course I'm going to be demonstrating
the other ways that you can use as well as comparing
and contrasting the advantages and disadvantages
of each of those methods. Now that's everything that I wanted to cover
in this demo lesson. You've learned how to create
an AMI and how to use it to save significant
effort on an ongoing basis. So let's clear up
all of the infrastructure that we've used in this lesson.
So move back to the AWS console, close down this tab
go back to instances and we need to manually terminate
the instance that we created from our custom AMI.
So right click and then go to terminate
instance. You'll need to confirm that. That will start the process
of termination. Now we're not going to delete the AMI or snapshots because
there's a demo coming up
later in this section of the course where you're going to get the experience
of copying and sharing an AMI between
AWS regions so we're going to need to leave this in place
so we're not going to delete the AMI or the snapshots created within this lesson.
Verify that that instance has been terminated
and once it has click on services, go to cloud formation
select the AMI demo stack, select delete
and then confirm that deletion and that will remove
all of the infrastructure that we've created within this demo lesson
and at this point that's everything that I wanted you to do
in this demo. So go ahead complete this video
and when you're ready I look forward to you joining me in the next.

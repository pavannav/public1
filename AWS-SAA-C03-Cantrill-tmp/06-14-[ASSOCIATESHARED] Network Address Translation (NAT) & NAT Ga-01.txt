Welcome back, this is part two of this lesson. We're going to continue immediately from the end of part one, so let's get started.
So focusing specifically on the Animals for Life scenario, so what we're going to do in the upcoming demo lesson,
to implement a truly resilient architecture for NAT services in a VPC, you need a NAT gateway in a public subnet
inside each availability zone that the VPC uses, so just like on the diagram that you've got on screen now.
And then, as a minimum, you need private route tables in each availability zone, in this example,
AZ-A, AZ-B, and then AZ-C. Each of these would need to have their own route table,
which would have a default IP version for route, which points at the NAT gateway in the same availability zone.
That way, if any availability zone fails, the others could continue operating without issues.
Now this is important, I've seen it in a few exam questions, where it suggests that one NAT gateway is enough,
that a NAT gateway is truly regionally resilient. This is false. A NAT gateway is highly available in the availability zone
that it's in, so if hardware fails, or it needs to scale to cope with load, it can do so in that AZ.
But if the whole AZ fails, there is no failover. You provision a NAT gateway into a specific availability zone,
not the region. It's not like the internet gateway, which by default is region resilient.
For a NAT gateway, you have to deploy one into each AZ that you use, if you need that region resilience.
Now my apologies in advance for the small text, it's far easier to have this all on screen at once.
I mentioned at the start of the lesson that NAT used to be provided by NAT instances,
and these are just the NAT process running on an EC2 instance.
Now I don't expect this to feature on the exam at this point, but if you ever need to use a NAT instance,
by default, EC2 filters all traffic that it sends or receives.
It essentially drops any data that is on its network card, when that network card is not either the source or the destination.
So if an instance is running as a NAT instance, then it will be receiving some data,
which the source address will be of other resources in that VPC, and the destination will be a host on the internet.
So it will neither be the source nor the destination, so by default that traffic will be dropped.
And if you need to allow an EC2 instance to function as a NAT instance,
then you need to disable a feature called source and destination checks.
This can be disabled via the console UI, the CLI or the API.
The only reason I mention this is I have seen this question in the exam before,
and if you do implement this in a real world production style scenario, you need to be aware that this feature exists.
I don't want you wasting your time trying to diagnose this feature.
So if you just right click on an instance in the console, you'll be able to see an option to disable source and destination checks.
And that is required if you want to use an EC2 instance as a NAT instance.
Now at the highest level, architecturally, NAT instances and NAT gateways are kind of the same.
They both need a public IP address, they both need to run in a public subnet, and they both need a functional internet gateway.
But at this point, it's not really preferred to use EC2 running as a NAT instance.
It's much easier to use a NAT gateway, and it's recommended by AWS in most situations.
But there are a few key scenarios where you might want to consider using an EC2-based NAT instance.
So let's just step through some of the criteria that you might be looking at when deploying NAT services.
If you value availability, bandwidth, low levels of maintenance and high performance,
then you should choose NAT gateways.
That goes for both real-world production usage as well as being default for answering any exam questions.
A NAT gateway offers high-end performance, it scales, it's custom designed to perform network address translation.
And that instance in comparison is limited by the capabilities of the instance it's running on.
And that instance is also general purpose, so won't offer the same level of custom designed performance as a NAT gateway.
Now, availability is another important consideration.
A NAT instance is a single EC2 instance running inside an availability zone.
It will fail if the EC2 hardware fails. It will fail if its storage fails or if its networking fails.
And it will fail if the AZ itself fails entirely.
A NAT gateway has some benefits over a NAT instance.
So inside one availability zone, it's highly available.
So it can automatically recover, it can automatically scale.
So it removes almost all of the risks of outage versus a NAT instance.
But it will still fail entirely if the AZ fails entirely.
You still need to provision multiple NAT gateways spread across all the AZs that you intend to use if you want to ensure complete availability.
For maximum availability, a NAT gateway in every AZ you use.
This is critical to remember for the exam.
Now, if cost is your primary choice, if you're a financially challenged business,
or if the VPC that you're deploying NAT services into is just a test VPC or something that's incredibly low volume,
then a NAT instance can be cheaper.
It can also be significantly cheaper at high volumes of data.
You've got a couple of options. You can use a very small EC2 instance, even ones that are free tier eligible to reduce costs.
And the instances can also be fixed in size, meaning they offer predictable costs.
And that gateway will scale automatically.
And you'll build for both the NAT gateway and the amount of data transferred, which increases as the gateway scales.
And that gateway is also not free tier eligible.
Now, this is really important because when we deploy these in the next demo lesson,
it's one of those services that I need to warn you will come at a cost.
So you need to be aware of that fact. You will be charged for a NAT gateway regardless of how small the usage.
NAT instances also offer other niche advantages because they're just EC2 instances.
You can connect to them just like you would any other EC2 instance.
You can multipurpose them so you can use them for other things such as bastion hosts.
You can also use them for port forwarding.
So you can have a port on the instance externally that can be connected to over the public internet
and have this forwarded on to an instance inside the VPC.
Maybe port 80 for web or port 443 for secure web.
You can be completely flexible when you use NAT instances.
With a NAT gateway, this isn't possible because you don't have access to manage it.
It's a managed service.
Now, this comes up all the time in the exam.
So try and get it really clear in your memory.
And NAT gateway cannot be used as a bastion host.
It cannot do port forwarding because you cannot connect to its operating system.
Now finally, and this is again one focused on the exam, NAT instances are just EC2 instances.
And so you can filter traffic using either network ACLs on the subnet the instance is in
or security groups directly associated with that instance.
NAT gateways don't support security groups.
You can only use NACLs with NAT gateways.
This one comes up all the time in the exam.
So it's worth noting down and maybe making a flashcard with.
Now a few more things before we finish up.
What about IP version 6?
Well, NAT is not required for IP version 6.
The main focus of NAT is to allow private IP version 4 addresses to be used
to connect in an outgoing only way to the AWS public zone and public internet.
Inside AWS, all IP version 6 addresses are publicly routable.
So this means that you do not require NAT when using IP version 6.
The internet gateway works directly with IP version 6 addresses.
So if you choose to make an instance in a private subnet,
have a default IP version 6 route to the internet gateway,
it will become a public instance.
As long as you don't have any NACLs or any security groups,
any IP version 6 IP address in AWS can communicate directly
with the AWS public zone and the public internet.
So the internet gateway can work directly with IP version 6.
NAT gateways do not work with IP version 6.
They're not required and they don't function with IP version 6.
So for the exam, if you see any questions which mention IP version 6 and NAT gateways,
you can exclude the answer.
NAT gateways do not work with IP version 6.
I need to repeat it because I really want it to stick in your memory.
So with any subnet inside AWS which has been configured for IP version 6,
if you add the IP version 6 default route, which is colon colon forward slash zero,
if you add that route and you point that route at the internet gateway as a target,
that will give that instance bidirectional connectivity to the public internet
and it will allow it to reach the AWS public zone and public services.
One service that we'll be talking about later on in the course
when I cover more advanced features of VPC is a different type of gateway
known as an egress-only internet gateway.
This is a specific type of internet gateway that works only with IP version 6
and you use it when you want to give an IP version 6 instance
outgoing only access to the public internet and the AWS public zone.
So don't worry, we'll be covering that later in the course,
but I want to get it really burned into your memory that you do not use NAT
and you do not use NAT gateways with IP version 6.
It will not work.
Now to get you some experience of using NAT gateways, it's time for a demo.
In the demo lesson, I'm going to be stepping you through what you need to do
to provision a completely resilient NAT gateway architecture.
So that's using a NAT gateway in each availability zone
as well as configuring the routing required to make it work.
It's going to be one of the final pieces to our multi-tier VPC
and it will allow private instances to have full outgoing internet access.
Now I can't wait for us to complete this together.
It's going to be a really interesting demo, one that will be really useful
if you're doing this in the real world or if you have to answer exam questions
related to NAT or NAT gateway.
So go ahead, complete the video and when you're ready, join me in the demo.

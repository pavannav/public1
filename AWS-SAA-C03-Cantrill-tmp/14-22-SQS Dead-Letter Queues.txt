Welcome back, and in this lesson I want to talk about dead letter queues, which is another
piece of SQS functionality which you need to be aware of. So let's just jump in and
get started.
Dead letter queues are designed to help you handle reoccurring failures while processing
messages which are within an SQS queue. So let's say that you have a queue, and inside
this queue is a single message. And let's say that this particular message is problematic.
Something about it is causing errors while processing it. So the first time that it's
received, it's invisible for the duration of the visibility timeout. Then once the visibility
timeout expires, it appears again in the queue, assuming that it hasn't been successfully
processed and then explicitly deleted. But imagine that this process happens again and
again. The message is received, processing fails, and eventually the message appears
after the visibility timeout. This process could continue forever, and it's this issue
which dead letter queues aim to fix. Every time the message is received, the receive
count attribute is incremented. Initially 1, then 2, then 3, then 4, then 5 and so on.
What we can do is define a redrive policy. So this defines the source queue, the dead
letter queue to use, and the conditions where the message will be moved into this dead letter
queue. And it defines a variable called max receive count. So how this works is that when
the receive count on a given message is more than the max receive count, and when the message
isn't explicitly deleted, it's moved to the dead letter queue. Setting up a dead
letter queue gives you some really useful pieces of functionality. It allows you to
configure an alarm for any messages which are delivered to a dead letter queue. So this
could automatically notify you if you have any problematic messages. It's a separate
area which allows you to perform separate isolated diagnostics. So you can examine logs
for a particular message to determine why it repeatedly failed processing. You can analyze
the contents of messages which are delivered to a dead letter queue to diagnose what's
causing the issue. And it also allows you to test or apply separate processing which
can be used for problematic messages. Now one really important thing to keep in mind
when you're using dead letter queues in the real world, all SQS queues have retention
periods for messages. So if a message ages past a certain point and hasn't been processed,
then that message is dropped. Now the way that this works is that when a message is
added to a queue, it has an NQ timestamp. So the timestamp of the point that it was
sent into the queue. Now when you're moving a message from a normal queue to a dead letter
queue, this NQ timestamp is not adjusted. So it remains the same, the timestamp is maintained
and it's the date and time when it was added to the original queue. So you have to be really
careful when a message is moved into a dead letter queue. If a message for example has
been in a source queue for one day and the retention period on a dead letter queue is
two days, the message will only remain in the dead letter queue for one additional day
because this original NQ timestamp is used rather than the date and time that the message
was moved into the dead letter queue. So generally the retention period of dead letter queues
should be longer than source queues and this takes into account that the NQ timestamp is
not updated when the message is moved between queues. So dead letter queues are a really
useful architecture which allows you to build additional rigour into any processes surrounding
queues. It allows you to define this dead letter queue which helps with diagnostics,
you can add additional processing features which allow problematic messages to be processed
and many other use cases. And finally a single dead letter queue can be used for multiple
source queues so that's also something to keep in mind. Now that's everything I wanted to cover
in this lesson so thanks for watching, go ahead and complete this video and when you're ready
I'll look forward to you joining me in the next.

Welcome back. In this lesson, I want to talk about a really important feature of EC2 called Instance Metadata.
It's a very simple architecture, but it's one that's used in many of EC2's more powerful features,
so it's essential that you understand its architecture fully.
It features in nearly all of the AWS exams, and you will use it often if you design and implement AWS solutions in the real world.
So let's jump in and get started.
The EC2 Instance Metadata is a service that EC2 provides to instances.
It's data about the instance that can be used to configure or manage a running instance.
It's a way the instance or anything running inside the instance can access information about the environment
that it wouldn't be able to access otherwise.
And it's accessible inside all instances using the same access method.
The IP address to access the instance metadata is 169.254.169.254.
Remember that IP. It comes up all the time in exams. Make sure it sticks.
I'll repeat it as often as I can throughout the course, but it's unusual enough that it tends to stick pretty well.
Now the way that I've remembered the IP address from when I started with AWS is just to keep repeating it.
Repetition always helps. And I remember this one as a little bit of a rhyme.
169.254 repeated. And if you just keep repeating that over and over again, then the IP address will stick.
So 169.254 repeated equals 169.254.169.254.
And then for the next part of the URL, I always want the latest meta hyphen data.
And if you remember 169.254 repeated and you always want the latest meta hyphen data,
it will tend to stick in your mind. At least it did for me.
Now I've seen horrible exam questions which make you actually select the exact URL for this metadata.
So this is one of those annoying facts that I just need you to memorize.
I promise you it will help you with exam questions in the exam.
So try to memorize the IP and latest meta hyphen data.
If you remember both of those, keep repeating them. Get annoying over and over again.
Write them on flashcards. It will help you in the exam.
Now the metadata allows anything running on the instance to query it for information about that instance.
And that information is divided into categories. For example, hostname, events, security groups, and much more.
All information about the environment that the instance is in.
The most common things which can be queried though are information on the networking.
And I'll show you this in the demo part of this lesson.
While the operating system of an instance can't see any of its IP version 4 public addressing,
the instance metadata can be used by applications running on that instance to get access to that information.
And I'll show you that soon. You can also gain access to authentication information.
We haven't covered EC2 instance roles yet.
But instances can be themselves given permissions to access AWS resources.
And the metadata is how applications on the instance can gain access to temporary credentials generated by assuming the role.
The metadata service is also used by AWS to pass in temporary SSH keys.
So when you connect to an instance using EC2 instance connect, it's actually passing in an SSH key behind the scenes that's used to connect.
The metadata service is also used to grant access to user data.
And this is a way that you can make the instance run scripts to perform automatic configuration steps when you launch an instance.
Now one really important fact for the exam, and I've seen questions come up on this one time and time again,
the metadata service, it has no authentication and it's not encrypted.
Anyone who can connect to an instance and gain access to the Linux command line shell can, by default, access the metadata.
You can restrict it with local firewall rules, so blocking access to the 169.254 repeated IP address,
but that's extra per instance admin overhead.
In general, you should treat the metadata as something that can and does get exposed.
Okay, well that's the architecture. It's nice and simple.
But this is one of the things inside AWS which is much easier to show you than to tell you about.
So it's time for a demo.
And we're going to perform a demo together which uses the instance metadata of this in your own environment.
Then you'll need to apply some infrastructure.
Before you do that, just make sure that you're logged in to the general AWS account,
so the management account of the organization, and make sure, as always, that you have the Northern Virginia region selected.
Now this lesson has a one-click deployment link attached to it, so go ahead and click that link.
This will take you to the quick create stack screen.
You should see that the stack name is called metadata.
Just scroll down to the bottom, check this box, and click on create stack.
Now this will automatically create all of the infrastructure which we'll be using,
so you'll need to wait for this stack to move into a create complete state.
We're also going to be using some commands within this demo lesson,
and also attached to this lesson is a lesson commands document which includes all of the commands that you'll be using.
So this will help you avoid errors.
You can either type these out manually or copy and paste them as I do them in the demo.
So at this point, go ahead and open that link as well.
It should look something like this.
There's not that many commands that we'll be using, but they are relatively long,
and so by using this document, we can avoid any typos.
Now just refresh this stack.
Again, it will need to be in a create complete state, so go ahead and pause this video,
wait for the stack to move into create complete, and then we're good to continue.
Okay, so now the stack's moved into a create complete state,
and if you just go ahead and click on resources, you can see that it's created a selection of resources.
Now the one that we're concerned with is public EC2,
which is an EC2 instance running in a public subnet with public IP addressing.
So we're going to go ahead and interact with this instance.
So click on services, and then go ahead and move to the EC2 console.
You can either select it in all services, recently visited if you've used this service before,
or you can type EC2 into the search box, and then open it in a new tab.
Once you're at the EC2 console, go ahead and click on instances running,
and you should see this single EC2 instance.
Go ahead and select it, and I just want to draw your attention to a number of key pieces of information
which I want you to note down.
So first, you'll be able to see that the instance has a private IP version 4 address.
Yours may well be different if you're doing this within your own environment.
You'll also see that the instance has a public IP version 4 address,
and again, if you're doing this in your environment, yours will be different.
Now if you click on networking, you'll be able to see additional networking information,
including the IP version 6 address that's allocated to this instance.
Now the IP version 6 address is always public, and so there's no concept of public and private IP version 6 addresses,
but you'll be able to see that address under the networking tab.
Now just to make this easier, just go ahead and note down the IP version 6 address,
as well as the public IP version 4 DNS which is listed,
as well as the public IP version 4 address which is listed at the top,
and then the private IP version 4 address.
And once you've got all of these noted down, we're going to go ahead and connect to this instance.
So right-click, select connect, we're going to use EC2 instance connect,
so make sure that the username is ec2-user, and then connect to this instance.
Now once we've connected straight away, we'll be able to see how even the prompt of the instance
makes visible the private IP version 4 address of this EC2 instance.
And if we run the Linux command of ifconfig and press enter,
we'll get an output of the network interfaces within this EC2 instance.
Now we'll be able to see the private IP version 4 address listed within the configuration
of this network interface inside the EC2 instance.
And if you're performing this in your own environment, notice how it's exactly the same
as the private IP version 4 address that you just noted down,
which was visible inside the console UI.
So in my case, you'll be able to see these two IP addresses match perfectly.
So this IP address that's visible in the console UI is the same as this private IP address
configured on the network interface inside the instance.
The same is true of the IP version 6 IP address.
It is also visible inside the operating system on the network configuration for this network interface.
And again, that's the same IP version 6 address which is visible on the networking tab inside the console UI.
So that's the same as this address.
What isn't visible inside the instance operating system on the networking configuration
is the public IP version 4 address.
It's critical to know that at no point ever during the lifecycle of an EC2 instance
is a public IP version 4 address configured within the operating system.
The operating system has no exposure to the public IP version 4 address.
That is performed by the internet gateway.
The internet gateway translates the private address into a public address.
So while IP version 6 is configured inside the operating system, IP version 4 public addresses are not.
The only IP version 4 addresses that an instance has are the private IP addresses.
And that's critical to understand.
Now as I talked about in the theory component of this lesson,
the EC2 metadata service is a service which runs behind all of the EC2 instances within your account.
And it's accessible using the metadata IP address.
Now we can access this by using the curl utility.
Now curl is installed on the EC2 instance that we're using for this demo.
Now we're going to query the metadata service for one particular attribute.
And that attribute is the public IP version 4 address of this instance.
So because the instance operating system has no knowledge of the public IP address,
we can use the metadata service to provide any scripts or applications running on this instance
with visibility of this public IP version 4 address.
And we do that using this command.
So this uses curl to query the metadata service which is 169.254.169.254.
I refer to this as 169.254 repeating.
So it queries this IP address and then forward slash latest, forward slash meta hyphen data.
And this is the metadata URL, this entire part.
The IP address, then latest, then meta hyphen data.
And then at the end we specify the attribute which we want to retrieve, which is public hyphen IPv4.
And if we press enter, then curl is going to contact the metadata service
and retrieve the public IP version 4 address of this EC2 instance.
So in my case, this is the IP address and if I go back to the console,
this matches the address that's visible within the console UI.
So if I just clear the screen to make it easier to see,
we can also use the same command structure again,
but this time query for the public hostname of this EC2 instance.
We use the same URL, so IP address and path,
but this time with query for public hyphen hostname.
And this will give us the IP version 4 public DNS of this EC2 instance.
So again, I'm going to clear the screen to make it easier to see.
Now we can make this process even easier.
We can use the AWS instance metadata query tool.
And to download it, we use this command.
So enter it and press enter.
This has just downloaded the tool directly.
So if we do a listing to list the current folder,
we can see the EC2 hyphen metadata tool.
Because this is Linux, we need to make it so that this tool is executable.
We do that with the chmod command.
So enter that and press enter.
And then we can run the EC2 hyphen metadata tool.
And we can use double hyphen help to display help for this product.
So this shows all of the different information that we can use this tool to query for.
And this just makes it easier to query the metadata service,
especially if the query is being performed by users running interactively on that EC2 instance.
So for example, we could run EC2 hyphen metadata space hyphen A
to show the AMI ID that's used to launch this instance.
And in this case, it's the AMI for Amazon Linux 2 inside the US hyphen East hyphen 1 region,
at least at the time of creating this demo video.
If we need to show the availability zone that this instance is in,
we could use EC2 hyphen metadata space hyphen Z.
In this case, the instance is in US hyphen East hyphen 1A.
And we can even use EC2 hyphen metadata space hyphen S
to show any security groups which were launched with this instance.
Now you can carry on exploring this tool if you want.
There are plenty of other pieces of information which are accessible using the metadata tool.
I just wanted to give you a brief introduction, show you how to download it,
how to make it executable, and how to run some of the basic options.
Now at this point, that's everything I wanted to cover in this brief demo component of this lesson.
I wanted to give you some exposure to how you can interact with the metadata service
which I covered from a theory perspective earlier in this lesson.
Now at this point, we need to clear up all of the infrastructure that we've used for this demo component.
So close down this tab, go back to the AWS console, move to CloudFormation,
select the metadata stack, select delete, and then confirm it.
And that will clear up all of the infrastructure that we've used
and return the account into the same state as it was at the start of this demo component of this video.
Now at that point, that's everything I wanted to cover.
You've learned about the theory of the metadata service
as well as experienced how to interact with it from a practical perspective.
So go ahead and complete this video.
And when you're ready, I'll look forward to you joining me in the next.

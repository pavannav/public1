# 26.3 Step-03- AWS EKS and X-Ray Network Design

-: Welcome back.In this lecture, we are going to understandabout how we are going to deployour applications in relation with AWS X-Ray on EKS cluster.So everything we are going to look into itfrom a network perspective,how it is going to look like.So let's go there and in AWS Cloud,so when we create a EKS cluster,it is going to create equivalent VPCand then public subnetsand then private subnets and then NAT gateway.But one thing important here,you need to observe from our previous network diagrams islike I have depicted only one availability zone.So I didn't depict one more availability zonebecause of lack of spacefor the depiction on my presentation.So whatever you are seeing 1A,the same thing also will be therein another availability zone also.But here I depicted only one thingdue to multiple components I need to cover in this depictionand then which you want to see itand the same thing will be availablein another availability zone also.So now, these things will get automatically created.So whenever you create a worker node groupmeans like whenever you create a EKS managed node group,so it also creates a worker nodeand whatever the applications deployed on this worker nodeand also this worker node related kubeletand all those stuff will communicate to the EKS clusterusing NAT gateway.Why because these worker nodes are createdin the private subnet.So moving on, whenever you deploy a X-Ray as a DaemonSetso it is going to create its X-Ray pods per worker node,one X-Ray podand then it is going to exposethat respective X-Ray pod related applicationusing X-Ray cluster IP service.So the next thing is we deploy our UMS deploymentmeans like user management applicationand then notification application.So it will have its own stuff.UMS will have its own node port serviceand then MySQL external name service.So notification servicewill have its notification cluster IP serviceand it's SMTP external name serviceto send the emails via simple email serviceand its own deployments, UMS deploymentand then notification service deployment.So the next thing is,so you will also create your ingress servicewhich is nothing but your application load balancerin the public subnet.And then whenever you create the ingress service,it will reference the SSL certificatefrom the certificate managerand also you're going to register your DNS namewith inside the route 53so using external DNS.So that's about the ingress service.Now when users want to access,so the application.So for X-Ray, I have provided a dedicated microservice.So all other microservices,whatever you have seen like create user, delete useror health status, those are different.And then for X-Ray related thing, so in this UMSand then in notification I have written the codewith X-Ray SDK to enable the X-Ray tracingfor only this respective microservice,which means you are callinga notification X-Ray microservicefrom user management microservice.So what happens at that time?So you can see hereums.q1cloud.com/usermgmt/notification X-Ray.So the request comes to the UMS ingress serviceand then it will go to the UMS node port serviceand then request will go to UMS pod.And then from thereit'll go to the notification cluster IP servicebecause you are calling the notification X-Ray service here.And then from there request will come backto the notification podand then serve the response whatever I have requested.So that's what happens on a entire flow basiswhenever you access this respective URL.So what next?So whenever it came to UMS pod, it will analyze that trafficand then it will send the detailsto the X-Ray cluster IP servicefrom which it will go to the X-Ray pod.In the same way, whenever the requestcame to notification service microservice pod,so from here, to access this notification X-Ray serviceit is going to send the traces to X-Ray cluster IP servicefrom which it will send to X-Ray pod.So this X-Ray pod will take the responsibility to connectto our X-Ray service via NAT gateway.Why, because everything is in private subnet,it'll go via NAT gateway to our AWS X-Ray.So now till here everything is good.So when you access other stuff,which is nothing but you worked on create user stuff,so user management create user,it will come to MySQLand then it'll store the data in RDS databaseand then it'll go to the notification service.From notification service, it will go to SMTPvia NAT gateway, it will go to simple email serviceand then send the email to the end user.But for this create user flow, whatever is there,we really didn't enable the X-Ray stuff.So means like X-Ray stuff in the sense,X-Ray stuff for contacting the services.In the sense like,from this service to this service, how it is contacting?So there will be a different wayto call one service calling another service in our codeto show them as one service calling another service.So even if you call a create user service,it will be depicted in our X-Ray,but when it is calling notification serviceit will consider as a different clientin the sense like it's a different node in the X-Ray.That's the reason whenever you are testing,try to test it with notification X-Rayso that you will get the complete picturehow it is going to look like.So the reason is there will be different waysto call our services from one service to another service.So in microservices, this is specificallya one minute introduction I'm going to give,what I've done here.So when you are calling a notification health statusfrom our user management microservice,I'm using REST template,which is the Spring Boot standard way of callingthe REST services, one service to another servicein microservices.But whenever I'm calling the notification X-Ray,it needs something called HttpClientBuilderwhich means likeI'm trying to use the X-Ray related thing here,which is nothing but X-Ray related HttpClientBuilder.So that's the reason whenever I call the X-Ray in this modelwith client builder, then only it is going to showthat one service calling another service.So whenever I do with REST template,what happens is whenever you callyour notification health status from user management,it is going to show in a different way in the X-Ray.We are going to see that in detail in our,when we are doing the implementation.But I am trying to explain thatand then nail down for youthat whenever you access this respective servicethen it is going to show youhow I am seeing the nodes,in the same way you are going to see it.So like this.So how I see it, user management microservicecalling the notification microservice,how I am seeing,when you test also it is going to look this way only.When you call that respective notification X-Ray service.Other services, whatever we have done earlieris not going to be same way.Now what is service map?You can see that as a client,whenever I access it as a client,so it went to UMS node port service,from there it went to notification serviceand then sent the traces to X-Ray.The whole thing happened.So here also it's the same thing.So as a client, as a user,I came and then I called the user management microserviceand then from thereit went into the notification microserviceand then served my notification X-Ray thing.So now you can see that we have also labeled itwith user management microserviceand then V1 notification microservice, everythingand then we are seeing all this in our X-Ray service map.Next thing is traces.So whenever you want to trace this respective thing,so what happened and then for this respective callwhat happened I want to see, so you can see it in detail.So whenever I called that notification X-Ray,it came to user management microserviceand then it went to V1 notification microservice.So what happened in user management microservice?You can see it here.It went to a method get notification app info,that is the method.So let's crosscheck that.So you can see, get notification app info,it went here in the code.And from here it is the thing.So from it,you called like thisget services kube1 cloud/user management notification X-Ray,it went to this respective methodand then from there it is callingremote get 8096/notification/xray.So that is the thing it is going to call.So which means it is trying to call this URLnotification.service.xray URL.So which will be present in here.So notification/xray in our application properties.So it called this link.And then from when it is calling this link,this get notification app info forwarded the requestto our notification cluster IP service.So that's what is present in our architecture also,notification cluster IP servicefrom user management microservice,you'll go to notification cluster IP service.So from here again where you went?You went into the notification microservicewhich is the microservice respective pod or container.So inside that you have something callednotification app version service method.So from that you served the content.So what happened end to end, you'll be able to see herein a detailed trace information.So now next level, which means like again if you clickon this user management microserviceor this notification microservice,so this is nothing but a container.So this respective container.So EKS container.So you are going to see the segments in detail.So what is that segments is like?So from start time, end time, durationand then the request URL is this oneand the request method is getand user agent to generate this request,means like who is the user agent is I used the postmanso it is showing postman.And the request client type it is showing,all this information,you will see in the overview tag of our segment section.So how we get the segment section iswhenever we click on this, double click on this,we get this entire section.So in addition to that, as this is a EKS thing,so I enable the EKS plugin in my code.So if you see here, in my codeif I go to X-Ray and then X-Ray config.So if you see here,I enabled the EKS plugin also with my code.So due to that what it will do is like,where is this?Yeah, so it will provide that EC2,I also enabled the EC2 plug in.So it will show on which instance IDand those information it will provideand X-Ray information it will provide.But you can see the most important thingin the resources section is EKS section.So in EKS section, you can find inside pod,pod information to which pod this request went in?So exactly that pod name it is provided.And inside that pod which container this request went in.So that information also it has provided.So this completes the introduction for our X-Ray end-to-end.So in our next lectures, we are going to go aheadand then implement the X-Ray with our microservices.So I'll see you in the next lectureuntil then, bye bye.Thank you.
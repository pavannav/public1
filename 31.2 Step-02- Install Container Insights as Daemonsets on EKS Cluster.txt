# 31.2 Step-02- Install Container Insights as Daemonsets on EKS Cluster

-: Welcome back.So we are in 18 EKS,monitoring using CloudWatch Container Insights.So we already discussed about introductory topicsabout this one in our introduction section.So we are moving on to our step two, which isassociate CloudWatch policyto our EKS worker node rules.So CloudWatch agent server policy need to be associatedwith our worker nodes EC2 roleso that it gets the means likethese worker nodes will get the accessto push the logs to the CloudWatch,or send the metrics to the CloudWatch Container Insights.Or It gives the CloudWatch Container Insights topull the information, whatever is presentin other pod metrics or cluster metrics.So, so now let's go back to our management console,and what I said here is go to your EC2 worker nodesand then find the IAM role parameterand then click on that role.So that is the easiest way.So I can go to EC2, right?And I have two EC2 worker nodes running here,so I can say, so this and then this so I can go to them.So those are targeted with the respect to EKS only, right?So these are EKS demo one, NG private one.So which means those are deployedin our private subnets kubectl get nodes -o widewill give us the external IP if it is associated,you can tell that it is on the public subnet of our cluster.If it is none, it is on the private subnet of our cluster.So I'll go here, and then findthe role EKS CTL EKS demo one, right?So from any one of the instance you can find your role,and then inside that role we are goingto associate the policy CloudWatch agent server policy.So let me go here andit is loading so just give it a minute.I don't know why it is slow.Okay, got it.Okay, so now let's go here and attach a policy nameCloudWatch agent server policy, right?So for our EC2 instance role worker EC2 instance rolewe have associated a new policy which is nothingbut CloudWatch agent server policy, so that's good.So now let's come back and install the Container Insights.So Container Insights you can install specifically,which means like you can install one afterthe other means like it will havethe components like CloudWatch agentand then FluentD CloudWatch agentis for our metrics to be pulled.And then you'll also have FluentD for pulling the logs alsomeans like from logs from our EKS cluster.So you can independently install CloudWatch agentand then FluentD, or with a quick start option,you can install everything.So we are going to use the quick start option toinstall both of the stuff, okay.So now when you are installing itso what it does we are going to look into first, okay?So this command will install everything.Okay, so what is this command?We'll see in a bit but what it does isit'll create a new namespace named Amazon -CloudWatchin our Kubernetes cluster,and then it'll create necessary security objects requiredfor creating that DaemonSet.So in simple terms it is going to create a DaemonSet,one DaemonSet for CloudWatch agentand then one DaemonSet for FluentD.So now we already seen DaemonSet when we aredoing the x-ray section, if you remember, right.So it'll create per node one pod for us in the DaemonSet.So the number of nodes increases the pods per nodeone pod for FluentD and then one podfor CloudWatch agent will be always installed on each node.So in this step it is going to create security rolecluster security account and then service accountand then cluster roll binding, whatever is required.Further it is going to createand it deploys the CloudWatch agent responsiblefor sending the metrics to the CloudWatchas a CloudWatch service enables as DaemonSetand it also deploys the FluentD responsiblefor sending the logs to the CloudWatch as a DaemonSetand it deploys ConfigMap configurations requiredfor this DaemonSet.So that's what this entire thing, so the entire CW agentand FluentD quick start dot AML is going to do.If you want you can open it,and then review it for your convenience.So means like you are now goodat AML and then you are now good,at reading lots of Kubernetes manifests after writing them.So now you can see that it creates a namespaceand then it creates a service account for usand it creates a cluster role binding and then cluster roleand it also creates the configmaps for CW agentand then it creates the DaemonSet for CW agentwith this information in the same way you'll have the samefor our FluentD also in the down.So like that,so if we can review whatever, whatever, evenwhatever AWS has provided.Okay, so now what is this template and what is the threeplace then cluster name and region.So this is that template information, which meanslike this whole value whatever is there is the template.And then inside this you are sending cluster name valueand then cluster region value so that in which region youare installing the CW agent and FluentDand in which cluster you are installing,you are providing thoseto your CW agent quick start dot aml.So in our class whenever, wherever you see cluster nameunderscore this in the red areahere you are going to replacewith your EKS demo one and region is US east one.So if you see here, that's what we have done here.So you can see right?So in for cluster name we have putEKS demo one and for region name we have put US east one.So now as we already completed the sectionwhich is associate cloud watch policyto our EKS worker nodes completed.So we can deploy this one now.So let's go here and then deploy it.Okay, so now it'll create associated stuffwhatever is required for us.It first created the namespacethen created the service account cluster rolesand then cluster role bindings and then configmapsand the DaemonSet for respect to CloudWatch agent.Again, same for service account for FluentD cluster rolecluster role binding and then configmapfor FluentD, and it's equal and DaemonSet.So now once it is created so we can clear,and then we can say kubectl -fand then verify the DaemonSet here.Okay, so as we have already provided the respective role,ideally there should be ready two by two is ready in both.Why? Because we have kubectl get nodes, two nodes.So we'll have two DaemonSet meanslike DaemonSet is per node, it is going to run.So two CloudWatch agentsand then two FluentD CloudWatches are going to run.Okay? So this completes the installation partof our Container Insights on our EKS cluster.So I'll see you in the next lecture.Until then, bye-bye.Thank you.